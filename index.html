<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL to Markdown Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdom/20.0.3/jsdom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/readability/0.4.4/Readability.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.2/turndown.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f7fafc;
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #718096;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f7fafc;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
        }

        .bookmarklet-section {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
        }

        .bookmarklet-section h3 {
            color: white;
            margin-bottom: 15px;
        }

        .bookmarklet-drag-area {
            background: rgba(255, 255, 255, 0.15);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .bookmarklet-drag-area:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .bookmarklet-link {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white !important;
            text-decoration: none !important;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: grab;
        }

        .bookmarklet-link:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .bookmarklet-link:active {
            cursor: grabbing;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .bookmarklet-section label {
            color: white;
        }

        input[type="url"], textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="url"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        .btn-white {
            background: white;
            color: #2d3748;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-white:hover {
            background: #f7fafc;
            transform: translateY(-2px);
        }

        .output-section {
            margin-top: 30px;
            padding: 25px;
            background: #1a202c;
            border-radius: 15px;
            position: relative;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .output-title {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .output-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        #markdownOutput {
            background: #2d3748;
            color: #e2e8f0;
            border: none;
            border-radius: 8px;
            padding: 20px;
            width: 100%;
            min-height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.loading {
            background: #bee3f8;
            color: #2a69ac;
            border: 1px solid #90cdf4;
        }

        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status.bookmarklet {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .feature-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .feature-desc {
            color: #718096;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .cors-info {
            background: #fef5e7;
            border: 1px solid #f6ad55;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .cors-info h4 {
            color: #c05621;
            margin-bottom: 8px;
        }

        .cors-info p {
            color: #744210;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .bookmarklet-detected {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .bookmarklet-detected h3 {
            margin-bottom: 10px;
        }

        .debug-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }

            .output-header {
                flex-direction: column;
                gap: 15px;
            }

            .output-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ URL to Markdown Converter</h1>
        <p class="subtitle">Convert any webpage to clean, formatted Markdown instantly - including authenticated pages!</p>

        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-title">üîê Authenticated Access</div>
                <div class="feature-desc">Use the bookmarklet to extract content from login-protected pages while you're logged in</div>
            </div>
            <div class="feature-card">
                <div class="feature-title">üåê Smart Content Extraction</div>
                <div class="feature-desc">Uses Mozilla's Readability to extract main content while filtering out ads, navigation, and clutter</div>
            </div>
            <div class="feature-card">
                <div class="feature-title">üìù GitHub-Compatible Markdown</div>
                <div class="feature-desc">Generates clean Markdown with tables, task lists, and all GitHub Flavored Markdown features</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="bookmarklet">üîê Bookmarklet (Best for Auth)</div>
            <div class="tab" data-tab="direct">üåê Direct URL</div>
            <div class="tab" data-tab="manual">üìÑ Manual HTML</div>
        </div>

        <!-- Bookmarklet Tab -->
        <div class="tab-content active" id="bookmarklet-tab">
            <div class="input-section bookmarklet-section">
                <h3>üîê Extract from Authenticated Pages</h3>
                <p style="margin-bottom: 20px; opacity: 0.9;">This bookmarklet works on ANY webpage - including those requiring login! Perfect for private dashboards, social media, internal tools, Google Sites, and more.</p>
                
                <div class="bookmarklet-drag-area">
                    <p style="margin-bottom: 15px; font-size: 18px; font-weight: 600;">üìå Drag this to your bookmarks bar:</p>
                    <a href="javascript:(function(){if(window.urlToMarkdownBookmarklet){alert('Bookmarklet already running!');return;}window.urlToMarkdownBookmarklet=true;try{console.log('üîç Clipboard Bookmarklet v7 starting on:',window.location.href);const isGoogleSite=window.location.hostname.includes('sites.google.com')||document.querySelector('.sites-header-cell-buffer')||document.querySelector('[data-is-preview-mode]')||document.querySelector('.sites-layout')||document.title.includes('Google Sites');console.log('üîç Is Google Site:',isGoogleSite);let article;if(isGoogleSite){console.log('üîç Using Google Sites extraction');const selectors=['.jZfhZe','.VEXWte','[data-is-preview-mode] .VEXWte','[role=main]','main','.sites-layout__main','.sites-canvas-main','.sites-page-content','.TeI8t','.XuV9uc'];let main=null;for(const sel of selectors){main=document.querySelector(sel);if(main&&(main.textContent||'').trim().length>50){console.log('üîç Found content with:',sel);break;}main=null;}if(!main){main=document.body;console.log('üîç Using body fallback for Google Site');}article={title:document.title||'Google Site',content:main.innerHTML,textContent:main.textContent||main.innerText||''};}else{console.log('üîç Using standard extraction');const content=document.querySelector('article')||document.querySelector('[role=main]')||document.querySelector('main')||document.body;article={title:document.title||'Extracted Content',content:content.innerHTML,textContent:content.textContent||content.innerText||''};}if(!article.textContent||article.textContent.trim().length<20){throw new Error('No content found ('+article.textContent.trim().length+' chars)');}const data={title:article.title,content:article.content,textContent:article.textContent,url:window.location.href,timestamp:Date.now(),source:'bookmarklet-v7-clipboard',pageType:isGoogleSite?'google-site':'generic'};console.log('üîç Extracted:',data.textContent.length,'characters');const chars=data.textContent.length;const dataStr=JSON.stringify(data);console.log('üîç Copying to clipboard...');navigator.clipboard.writeText(dataStr).then(()=>{console.log('‚úÖ Copied to clipboard successfully');const proceed=confirm('Content extracted ('+chars+' chars) and copied to clipboard!\\n\\nClick OK to open converter - it will automatically paste and process your content.');if(proceed){console.log('üîç Opening converter...');const converterUrl='https://bhwilkoff.github.io/url-to-markdown-converter/?method=clipboard&chars='+chars+'&t='+Date.now();window.open(converterUrl,'_blank');console.log('‚úÖ Converter opened!');}}).catch(err=>{console.log('‚ùå Clipboard failed:',err);alert('Clipboard access failed. Your browser may not support this feature.\\n\\nExtracted '+chars+' characters.\\nPlease use the Manual HTML tab in the converter and paste manually.');})}catch(e){console.error('üîç Bookmarklet error:',e);alert('Error: '+e.message+'\\nCheck console for details.');}})();" class="bookmarklet-link" id="bookmarkletLink">üìÑ‚ûúüìù Extract to Markdown v7</a>
                    <p style="margin-top: 15px; font-size: 14px; opacity: 0.9;"><strong>üîÑ New:</strong> Simple clipboard-based transfer - copies content to clipboard, then auto-pastes in converter. Most reliable method!</p>
                </div>

                <div class="instructions">
                    <h4 style="margin-bottom: 15px; color: white;">üìã How to use:</h4>
                    <ol style="color: rgba(255,255,255,0.9);">
                        <li><strong>Drag the button above</strong> to your browser's bookmarks bar</li>
                        <li><strong>Visit any webpage</strong> (public or requiring login)</li>
                        <li><strong>Click the bookmarklet</strong> in your bookmarks bar</li>
                        <li><strong>Content automatically opens</strong> in this tool for markdown conversion</li>
                    </ol>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: white;">üîß Troubleshooting for Google Sites & Complex Pages:</h4>
                        <ul style="color: rgba(255,255,255,0.9); margin-left: 20px;">
                            <li><strong>If you get an error:</strong> Try refreshing the page first, then click the bookmarklet again</li>
                            <li><strong>For Google Sites:</strong> Make sure you're viewing the published site, not editing mode</li>
                            <li><strong>For restricted sites:</strong> Some sites block content extraction - try copying the HTML manually in the Manual HTML tab</li>
                            <li><strong>For dynamic content:</strong> Wait for the page to fully load before clicking the bookmarklet</li>
                            <li><strong>Debug info:</strong> Check the browser console (F12) for detailed extraction logs</li>
                        </ul>
                    </div>
                    
                    <p style="margin-top: 15px; opacity: 0.9;"><strong>üí° Pro tip:</strong> This works on LinkedIn, Facebook, private dashboards, internal tools, Notion pages, Google Sites, and any other authenticated content!</p>
                </div>

                <div class="button-group">
                    <button class="btn-white" onclick="copyBookmarkletCode()">
                        üìã Copy Bookmarklet Code
                    </button>
                    <button class="btn-white" onclick="testBookmarklet()">
                        üß™ Test on This Page
                    </button>
                    <button class="btn-white" onclick="manualCheckForData()">
                        üîÑ Check for Extracted Data
                    </button>
                    <button class="btn-white" onclick="tryDifferentExtraction()">
                        üîÑ Try Different Method
                    </button>
                    <button class="btn-white" onclick="showManualInstructions()">
                        üìñ Manual Instructions
                    </button>
                </div>
            </div>
        </div>

        <!-- Direct URL Tab -->
        <div class="tab-content" id="direct-tab">
            <div class="input-section">
                <div class="input-group">
                    <label for="urlInput">üìé Website URL</label>
                    <input type="url" id="urlInput" placeholder="https://example.com/article" />
                    <div class="button-group">
                        <button class="btn-primary" onclick="pasteFromClipboard()">
                            üìã Paste from Clipboard & Convert
                        </button>
                        <button class="btn-secondary" onclick="convertFromURL()">
                            üîÑ Convert URL
                        </button>
                    </div>
                </div>

                <div class="cors-info">
                    <h4>üîí Limitations of Direct URL Method</h4>
                    <p><strong>‚úÖ Works for:</strong> Public websites, most blogs, news sites, documentation</p>
                    <p><strong>‚ùå Won't work for:</strong> Login-required pages, some modern SPAs, CORS-protected sites</p>
                    <p><strong>üí° For authenticated content:</strong> Use the Bookmarklet tab above!</p>
                </div>
            </div>
        </div>

        <!-- Manual HTML Tab -->
        <div class="tab-content" id="manual-tab">
            <div class="input-section">
                <div class="input-group">
                    <label for="htmlInput">üìÑ Raw HTML Source Code</label>
                    <textarea id="htmlInput" placeholder="Paste raw HTML source code here for authenticated pages or when URL fetch fails..."></textarea>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="convertFromHTML()">
                            üîÑ Convert HTML
                        </button>
                    </div>
                </div>
                <div class="cors-info">
                    <h4>üìã How to get HTML source:</h4>
                    <p>1. Visit the page in your browser while logged in</p>
                    <p>2. Right-click ‚Üí "View Page Source" or press Ctrl+U (Cmd+U on Mac)</p>
                    <p>3. Copy all the HTML and paste it above</p>
                </div>
            </div>
        </div>

        <div id="statusDiv"></div>

        <div class="output-section hidden" id="outputSection">
            <div class="output-header">
                <div class="output-title">üìù Markdown Output</div>
                <div class="output-actions">
                    <button class="btn-small btn-secondary" onclick="copyToClipboard()">
                        üìã Copy
                    </button>
                    <button class="btn-small btn-success" onclick="downloadMarkdown()">
                        üíæ Download
                    </button>
                    <button class="btn-small btn-primary" onclick="shareMarkdown()" id="shareBtn">
                        üîó Share
                    </button>
                </div>
            </div>
            <textarea id="markdownOutput" readonly></textarea>
        </div>
    </div>

    <script>
        let extractedContent = '';
        let originalUrl = '';

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });

        // Initialize turndown with GFM extensions
        const turndownService = new TurndownService({
            headingStyle: 'atx',
            codeBlockStyle: 'fenced',
            fence: '```',
            emDelimiter: '*',
            strongDelimiter: '**',
            linkStyle: 'inlined',
            linkReferenceStyle: 'full',
            br: '',
            preformattedCode: false,
            blankReplacement: function (content, node) {
                return node.isBlock ? '\n\n' : '';
            },
            keepReplacement: function (content, node) {
                return node.isBlock ? '\n\n' + node.outerHTML + '\n\n' : node.outerHTML;
            },
            defaultReplacement: function (content, node) {
                return node.isBlock ? '\n\n' + content + '\n\n' : content;
            }
        });

        // Add GFM extensions
        turndownService.addRule('strikethrough', {
            filter: ['del', 's', 'strike'],
            replacement: function (content) {
                return '~~' + content + '~~';
            }
        });

        turndownService.addRule('taskList', {
            filter: function (node) {
                return node.type === 'checkbox' && node.parentNode.nodeName === 'LI';
            },
            replacement: function (content, node) {
                return (node.checked ? '[x]' : '[ ]') + ' ';
            }
        });

        turndownService.addRule('table', {
            filter: 'table',
            replacement: function (content, node) {
                const rows = Array.from(node.querySelectorAll('tr'));
                let markdown = '\n';
                
                rows.forEach((row, index) => {
                    const cells = Array.from(row.querySelectorAll('td, th'));
                    const rowContent = cells.map(cell => cell.textContent.trim()).join(' | ');
                    markdown += '| ' + rowContent + ' |\n';
                    
                    if (index === 0 && row.querySelector('th')) {
                        markdown += '|' + cells.map(() => ' --- ').join('|') + '|\n';
                    }
                });
                
                return markdown + '\n';
            }
        });

        // Check for bookmarklet data on page load
        window.addEventListener('load', function() {
            // Add small delay to ensure DOM is ready
            setTimeout(() => {
                // Check for postMessage method first
                if (checkForPostMessageMethod()) {
                    return; // PostMessage setup active
                }
                
                // Check for form POST data
                if (checkForFormPostData()) {
                    return; // Form data found and processed
                }
                
                // Then check storage methods
                checkForBookmarkletData();
            }, 100);
        });

        // Set up postMessage listener for bookmarklet data  
        function checkForPostMessageMethod() {
            const urlParams = new URLSearchParams(window.location.search);
            const method = urlParams.get('method');
            
            if (method === 'postmessage') {
                console.log('üîç PostMessage method detected, setting up improved listener');
                const expectedChars = urlParams.get('chars');
                showStatus(`üîÑ Waiting for data transfer (expecting ${expectedChars} characters)...`, 'loading');
                
                let dataReceived = false;
                let lastAttempt = 0;
                
                // Set up postMessage listener
                window.addEventListener('message', function(event) {
                    // Security check - only accept messages from GitHub Pages
                    if (event.origin !== 'https://bhwilkoff.github.io' && 
                        event.origin !== 'http://localhost' && 
                        event.origin !== window.location.origin) {
                        console.log('üîç Rejected message from:', event.origin);
                        return;
                    }
                    
                    if (event.data && event.data.type === 'BOOKMARKLET_DATA' && !dataReceived) {
                        dataReceived = true;
                        console.log('üîç Received bookmarklet data via postMessage');
                        console.log('üîç Data size:', event.data.data.textContent.length, 'characters');
                        console.log('üîç Received after attempt:', event.data.attempt || 'unknown');
                        
                        showStatus('‚úÖ Data received via postMessage! Processing...', 'success');
                        
                        setTimeout(() => {
                            processBookmarkletData(event.data.data);
                        }, 500);
                    } else if (event.data && event.data.attempt && !dataReceived) {
                        // Update progress indicator
                        lastAttempt = event.data.attempt;
                        if (lastAttempt % 10 === 0) { // Update every 10 attempts
                            showStatus(`üîÑ Data transfer in progress... (attempt ${lastAttempt}/100)`, 'loading');
                        }
                    }
                });
                
                // Send ready signal back to opener immediately and repeatedly
                const sendReadySignal = () => {
                    if (window.opener && !window.opener.closed) {
                        try {
                            window.opener.postMessage({type: 'CONVERTER_READY'}, 'https://bhwilkoff.github.io');
                            console.log('üîç Sent ready signal to opener');
                        } catch (e) {
                            console.log('üîç Could not send ready signal:', e);
                        }
                    }
                };
                
                // Send ready signal immediately and then every 500ms for first 10 seconds
                sendReadySignal();
                const readyInterval = setInterval(sendReadySignal, 500);
                setTimeout(() => clearInterval(readyInterval), 10000);
                
                // Extended timeout - 35 seconds (100 attempts at 300ms + buffer)
                setTimeout(() => {
                    if (!dataReceived) {
                        showStatus('‚ùå Data transfer timed out after 35 seconds. Please try again.', 'error');
                        
                        const timeoutHtml = `
                            <div class="debug-info" style="margin-top: 15px; background: #fff3cd; border-color: #ffeaa7;">
                                <strong>‚è±Ô∏è PostMessage Transfer Timeout</strong><br><br>
                                The transfer didn't complete after 100 attempts (${lastAttempt} attempts made).<br><br>
                                <strong>What likely happened:</strong><br>
                                1. <strong>Browser blocked cross-tab communication</strong> - Some browsers restrict postMessage<br>
                                2. <strong>Source tab was closed/refreshed</strong> - Keep the original page open<br>
                                3. <strong>Network/browser issue</strong> - Try refreshing and running bookmarklet again<br><br>
                                <strong>Solutions:</strong><br>
                                ‚Ä¢ <strong>Try again</strong> - Click the bookmarklet once more on the source page<br>
                                ‚Ä¢ <strong>Different browser</strong> - Chrome/Firefox may work better<br>
                                ‚Ä¢ <strong>Manual method</strong> - Use the Manual HTML tab to copy/paste the page source<br>
                                ‚Ä¢ <strong>Check console</strong> - Press F12 on source page for any error messages
                            </div>
                        `;
                        document.getElementById('statusDiv').innerHTML += timeoutHtml;
                    }
                }, 35000);
                
                return true;
            }
            
            return false;
        }
        function checkForFormPostData() {
            const urlParams = new URLSearchParams(window.location.search);
            const method = urlParams.get('method');
            
            // Check if this is a form POST
            if (method === 'form-post' || document.body.innerHTML.includes('extractedContent')) {
                try {
                    // Try to get data from URL parameters (fallback)
                    const formData = {
                        title: urlParams.get('extractedTitle') || 'Extracted Content',
                        content: urlParams.get('extractedContent') || '',
                        textContent: urlParams.get('extractedText') || '',
                        url: urlParams.get('sourceUrl') || window.location.href,
                        timestamp: parseInt(urlParams.get('extractedTimestamp')) || Date.now(),
                        source: urlParams.get('source') || 'bookmarklet-form',
                        pageType: urlParams.get('pageType') || 'generic'
                    };
                    
                    // Check if we have content
                    if (formData.content && formData.content.length > 50) {
                        console.log('üîç Found form POST data in URL parameters');
                        showStatus('‚úÖ Content received via secure form POST! Processing...', 'success');
                        
                        setTimeout(() => {
                            processBookmarkletData(formData);
                        }, 500);
                        
                        return true;
                    }
                    
                    // If no URL parameters, show help message
                    if (method === 'form-post') {
                        console.log('üîç Form POST detected but no data in URL parameters');
                        showStatus('üîÑ Form POST detected. If content doesn\'t appear automatically, try the extraction again.', 'loading');
                        
                        // Add instructions for user
                        const instructionsHtml = `
                            <div class="debug-info" style="margin-top: 15px; background: #e3f2fd; border-color: #2196f3;">
                                <strong>üìù Form POST Method Active</strong><br><br>
                                The bookmarklet used a secure form submission method to transfer your content. If the content doesn't appear automatically:<br><br>
                                <strong>1. Wait a moment</strong> - Form processing may take a few seconds<br>
                                <strong>2. Check other tabs</strong> - Content might have opened in a different tab<br>
                                <strong>3. Try again</strong> - Click the bookmarklet on your source page again<br>
                                <strong>4. Manual fallback</strong> - Use the Manual HTML tab if needed<br><br>
                                <em>This method bypasses browser storage limitations and should work reliably.</em>
                            </div>
                        `;
                        document.getElementById('statusDiv').innerHTML += instructionsHtml;
                        
                        return true;
                    }
                    
                } catch (error) {
                    console.error('Error processing form POST data:', error);
                    showStatus('‚ùå Error processing form data: ' + error.message, 'error');
                }
            }
            
            return false;
        }
        function checkForPostMessageMethod() {
            const urlParams = new URLSearchParams(window.location.search);
            const method = urlParams.get('method');
            
            if (method === 'postmessage') {
                console.log('üîç PostMessage method detected, setting up listener');
                showStatus('üîÑ Waiting for data transfer from bookmarklet...', 'loading');
                
                let dataReceived = false;
                
                // Set up postMessage listener
                window.addEventListener('message', function(event) {
                    // Security check - only accept messages from GitHub Pages
                    if (event.origin !== 'https://bhwilkoff.github.io' && 
                        event.origin !== 'http://localhost' && 
                        event.origin !== window.location.origin) {
                        console.log('üîç Rejected message from:', event.origin);
                        return;
                    }
                    
                    if (event.data && event.data.type === 'BOOKMARKLET_DATA' && !dataReceived) {
                        dataReceived = true;
                        console.log('üîç Received bookmarklet data via postMessage');
                        console.log('üîç Data size:', event.data.data.textContent.length, 'characters');
                        
                        showStatus('‚úÖ Data received via secure postMessage! Processing...', 'success');
                        
                        setTimeout(() => {
                            processBookmarkletData(event.data.data);
                        }, 500);
                    }
                });
                
                // Send ready signal back to opener
                if (window.opener) {
                    try {
                        window.opener.postMessage({type: 'CONVERTER_READY'}, '*');
                        console.log('üîç Sent ready signal to opener');
                    } catch (e) {
                        console.log('üîç Could not send ready signal:', e);
                    }
                }
                
                // Timeout after 30 seconds
                setTimeout(() => {
                    if (!dataReceived) {
                        showStatus('‚ùå Data transfer timed out. Please try the bookmarklet again or use Manual HTML method.', 'error');
                        
                        const timeoutHtml = `
                            <div class="debug-info" style="margin-top: 15px; background: #fff3cd; border-color: #ffeaa7;">
                                <strong>‚è±Ô∏è PostMessage Transfer Timeout</strong><br><br>
                                The secure data transfer didn't complete within 30 seconds. This can happen if:<br><br>
                                <strong>1. Browser security blocked the transfer</strong> - Try allowing popups<br>
                                <strong>2. Source window was closed</strong> - Keep the original page open<br>
                                <strong>3. Network/timing issue</strong> - Try the bookmarklet again<br><br>
                                <strong>Alternative:</strong> Use the Manual HTML tab to copy/paste the page source directly.
                            </div>
                        `;
                        document.getElementById('statusDiv').innerHTML += timeoutHtml;
                    }
                }, 30000);
                
                return true;
            }
            
            return false;
        }

        function checkForBookmarkletData() {
            // Check multiple storage locations with backup keys
            let bookmarkletData = localStorage.getItem('urlToMarkdownData');
            let dataSource = 'localStorage';
            
            // Check backup localStorage key
            if (!bookmarkletData) {
                bookmarkletData = localStorage.getItem('urlToMarkdownBackup');
                dataSource = 'localStorage-backup';
            }
            
            // If localStorage is empty, check sessionStorage
            if (!bookmarkletData) {
                bookmarkletData = sessionStorage.getItem('urlToMarkdownData');
                dataSource = 'sessionStorage';
            }
            
            // Check backup sessionStorage key
            if (!bookmarkletData) {
                bookmarkletData = sessionStorage.getItem('urlToMarkdownBackup');
                dataSource = 'sessionStorage-backup';
            }
            
            // If both storage methods are empty, check URL parameters
            if (!bookmarkletData) {
                const urlParams = new URLSearchParams(window.location.search);
                const encodedData = urlParams.get('data');
                if (encodedData) {
                    try {
                        // Try new encoding method first (unescape + encodeURIComponent + btoa)
                        bookmarkletData = decodeURIComponent(escape(atob(encodedData)));
                        dataSource = 'URL parameters (new format)';
                        console.log('üîç Found data in URL parameters (new format)');
                    } catch (e) {
                        try {
                            // Fallback to simple base64
                            bookmarkletData = atob(encodedData);
                            dataSource = 'URL parameters (legacy format)';
                            console.log('üîç Found data in URL parameters (legacy format)');
                        } catch (e2) {
                            console.log('üîç Failed to decode URL data:', e2);
                        }
                    }
                }
            }
            
            if (bookmarkletData) {
                try {
                    const data = JSON.parse(bookmarkletData);
                    
                    // Clear the data from all sources to prevent re-processing
                    localStorage.removeItem('urlToMarkdownData');
                    localStorage.removeItem('urlToMarkdownBackup');
                    sessionStorage.removeItem('urlToMarkdownData');
                    sessionStorage.removeItem('urlToMarkdownBackup');
                    
                    // Show success message with data source
                    showStatus(`‚úÖ Content extracted via bookmarklet (from ${dataSource})! Processing...`, 'bookmarklet');
                    
                    // Show debug info if available
                    if (data.debug) {
                        console.log('üîç Bookmarklet data received:', data.debug);
                        showDebugInfo(data.debug);
                    }
                    
                    // Process the extracted content
                    setTimeout(() => {
                        processBookmarkletData(data);
                    }, 500);
                    
                    return true;
                } catch (error) {
                    console.error('Error processing bookmarklet data:', error);
                    localStorage.removeItem('urlToMarkdownData');
                    localStorage.removeItem('urlToMarkdownBackup');
                    sessionStorage.removeItem('urlToMarkdownData');
                    sessionStorage.removeItem('urlToMarkdownBackup');
                    showStatus('‚ùå Error processing bookmarklet data: ' + error.message, 'error');
                }
            }
            return false;
        }

        function showDebugInfo(debugData) {
            const statusDiv = document.getElementById('statusDiv');
            const debugHtml = `
                <div class="debug-info">
                    <strong>üîç Debug Information:</strong><br>
                    Page Type: ${debugData.pageType || 'unknown'}<br>
                    Is Google Site: ${debugData.isGoogleSite || 'unknown'}<br>
                    Hostname: ${debugData.hostname || 'unknown'}<br>
                    Text Length: ${debugData.originalTextLength || 'unknown'} characters
                </div>
            `;
            statusDiv.innerHTML += debugHtml;
        }

        async function processBookmarkletData(data) {
            try {
                originalUrl = data.url;
                
                const pageTypeText = data.pageType === 'google-site' ? ' (Google Site)' : '';
                await showStatus(`üîÑ Converting bookmarklet content to Markdown${pageTypeText}...`, 'loading');

                // Convert to Markdown
                let markdown = '';
                
                // Add title if available
                if (data.title && data.title.trim()) {
                    markdown += `# ${data.title.trim()}\n\n`;
                }

                // Add source URL if available
                if (data.url) {
                    markdown += `> Source: [${data.url}](${data.url})\n`;
                    markdown += `> Extracted: ${new Date(data.timestamp).toLocaleString()}`;
                    if (data.pageType) {
                        markdown += ` (${data.pageType})`;
                    }
                    markdown += `\n\n`;
                }

                // Convert content
                const contentMarkdown = turndownService.turndown(data.content);
                markdown += contentMarkdown;

                // Clean up the markdown
                markdown = markdown
                    .replace(/\n{3,}/g, '\n\n') // Remove excessive newlines
                    .replace(/^\s+/gm, '') // Remove leading whitespace
                    .trim();

                extractedContent = markdown;
                
                // Display the result
                document.getElementById('markdownOutput').value = markdown;
                document.getElementById('outputSection').classList.remove('hidden');
                
                const successMessage = data.pageType === 'google-site' ? 
                    `‚úÖ Successfully converted Google Site content! Generated ${markdown.length} characters of Markdown.` :
                    `‚úÖ Successfully converted via bookmarklet! Generated ${markdown.length} characters of Markdown from authenticated page.`;
                
                await showStatus(successMessage, 'success');
                
                // Scroll to output
                document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Bookmarklet processing error:', error);
                showStatus(`‚ùå Error processing bookmarklet content: ${error.message}. If this persists, try the Manual HTML tab instead.`, 'error');
            }
        }

        async function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('statusDiv');
            const existingContent = statusDiv.innerHTML;
            statusDiv.innerHTML = existingContent + `<div class="status ${type}">${message}</div>`;
            statusDiv.scrollIntoView({ behavior: 'smooth' });
        }

        async function clearStatus() {
            document.getElementById('statusDiv').innerHTML = '';
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                const urlInput = document.getElementById('urlInput');
                
                if (text && (text.startsWith('http://') || text.startsWith('https://'))) {
                    urlInput.value = text;
                    await convertFromURL();
                } else {
                    showStatus('‚ùå No valid URL found in clipboard. Please paste a URL manually.', 'error');
                }
            } catch (err) {
                showStatus('‚ùå Could not access clipboard. Please paste the URL manually.', 'error');
            }
        }

        async function convertFromURL() {
            const url = document.getElementById('urlInput').value.trim();
            
            if (!url) {
                showStatus('‚ùå Please enter a URL', 'error');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showStatus('‚ùå Please enter a valid URL starting with http:// or https://', 'error');
                return;
            }

            originalUrl = url;
            await showStatus('üîÑ Fetching webpage...', 'loading');

            try {
                // Try direct fetch first
                const response = await fetch(url, {
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const html = await response.text();
                await processHTML(html, url);

            } catch (error) {
                console.error('Direct fetch failed:', error);
                
                // Try CORS proxy as fallback
                try {
                    await showStatus('üîÑ Trying alternative method...', 'loading');
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Proxy failed: ${response.status}`);
                    }

                    const html = await response.text();
                    await processHTML(html, url);

                } catch (proxyError) {
                    console.error('Proxy fetch failed:', proxyError);
                    showStatus(`‚ùå Could not fetch URL. For authenticated content, please use the Bookmarklet tab! Error: ${error.message}`, 'error');
                }
            }
        }

        async function convertFromHTML() {
            const html = document.getElementById('htmlInput').value.trim();
            
            if (!html) {
                showStatus('‚ùå Please paste HTML content', 'error');
                return;
            }

            await showStatus('üîÑ Processing HTML...', 'loading');
            await processHTML(html, 'Manual HTML Input');
        }

        async function processHTML(html, source) {
            try {
                // Create a DOM parser
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Check if we got valid content
                if (!doc.body || doc.body.children.length === 0) {
                    throw new Error('Could not parse HTML content');
                }

                await showStatus('üîÑ Extracting main content...', 'loading');

                // Try to use Readability for content extraction
                let article;
                try {
                    const readabilityDoc = doc.cloneNode(true);
                    const reader = new Readability(readabilityDoc);
                    article = reader.parse();
                } catch (readabilityError) {
                    console.warn('Readability failed, using full body:', readabilityError);
                    article = {
                        title: doc.title || 'Untitled',
                        content: doc.body.innerHTML,
                        textContent: doc.body.textContent,
                        length: doc.body.textContent.length
                    };
                }

                if (!article || !article.content) {
                    throw new Error('Could not extract content from the page');
                }

                await showStatus('üîÑ Converting to Markdown...', 'loading');

                // Convert to Markdown
                let markdown = '';
                
                // Add title if available
                if (article.title && article.title.trim()) {
                    markdown += `# ${article.title.trim()}\n\n`;
                }

                // Add source URL if available
                if (originalUrl && originalUrl !== 'Manual HTML Input') {
                    markdown += `> Source: [${originalUrl}](${originalUrl})\n\n`;
                }

                // Convert content
                const contentMarkdown = turndownService.turndown(article.content);
                markdown += contentMarkdown;

                // Clean up the markdown
                markdown = markdown
                    .replace(/\n{3,}/g, '\n\n') // Remove excessive newlines
                    .replace(/^\s+/gm, '') // Remove leading whitespace
                    .trim();

                extractedContent = markdown;
                
                // Display the result
                document.getElementById('markdownOutput').value = markdown;
                document.getElementById('outputSection').classList.remove('hidden');
                
                await showStatus(`‚úÖ Successfully converted! Generated ${markdown.length} characters of Markdown.`, 'success');
                
                // Scroll to output
                document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Processing error:', error);
                showStatus(`‚ùå Error processing content: ${error.message}`, 'error');
            }
        }

        function manualCheckForData() {
            console.log('üîç Manual check for bookmarklet data triggered');
            showStatus('üîÑ Manually checking for bookmarklet data...', 'loading');
            
            // Check URL parameters for clues
            const urlParams = new URLSearchParams(window.location.search);
            const fromBookmarklet = urlParams.get('from') === 'bookmarklet';
            const method = urlParams.get('method');
            const timestamp = urlParams.get('t');
            const encodedData = urlParams.get('data');
            const storageMethod = urlParams.get('storage');
            const expectedChars = urlParams.get('chars');
            
            // First, let's see what's actually in storage
            
            // First, let's see what's actually in storage
            const localStorageContents = {};
            const sessionStorageContents = {};
            
            // Get all localStorage contents
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                try {
                    localStorageContents[key] = localStorage.getItem(key);
                } catch (e) {
                    localStorageContents[key] = `Error reading: ${e.message}`;
                }
            }
            
            // Get all sessionStorage contents
            for (let i = 0; i < sessionStorage.length; i++) {
                const key = sessionStorage.key(i);
                try {
                    sessionStorageContents[key] = sessionStorage.getItem(key);
                } catch (e) {
                    sessionStorageContents[key] = `Error reading: ${e.message}`;
                }
            }
            
            console.log('üîç Complete localStorage contents:', localStorageContents);
            console.log('üîç Complete sessionStorage contents:', sessionStorageContents);
            
            // Show comprehensive debug info
            const storageDebugHtml = `
                <div class="debug-info" style="margin-top: 15px;">
                    <strong>üîç Comprehensive Debug Information:</strong><br>
                    <strong>From Bookmarklet:</strong> ${fromBookmarklet ? 'Yes' : 'No'}<br>
                    <strong>Transfer Method:</strong> ${method || storageMethod || 'Unknown'}<br>
                    <strong>Expected Content:</strong> ${expectedChars ? expectedChars + ' characters' : 'Unknown'}<br>
                    <strong>Timestamp:</strong> ${timestamp ? new Date(parseInt(timestamp)).toLocaleString() : 'None'}<br>
                    <strong>URL Data Present:</strong> ${encodedData ? 'Yes (' + encodedData.length + ' chars)' : 'No'}<br>
                    <strong>localStorage keys:</strong> ${Object.keys(localStorageContents).join(', ') || 'empty'}<br>
                    <strong>sessionStorage keys:</strong> ${Object.keys(sessionStorageContents).join(', ') || 'empty'}<br>
                    <strong>URL:</strong> ${window.location.href}<br>
                    <strong>Domain:</strong> ${window.location.hostname}<br>
                    <strong>Storage Support:</strong> localStorage: ${typeof(Storage) !== "undefined" ? 'Yes' : 'No'}<br>
                    <strong>Time Since Timestamp:</strong> ${timestamp ? Math.round((Date.now() - parseInt(timestamp)) / 1000) + ' seconds ago' : 'N/A'}
                </div>
            `;
            document.getElementById('statusDiv').innerHTML += storageDebugHtml;
            
            // Try to process URL data if present
            if (encodedData) {
                try {
                    console.log('üîç Attempting to decode URL data...');
                    const decoded = decodeURIComponent(escape(atob(encodedData)));
                    const data = JSON.parse(decoded);
                    if (data.content || data.textContent) {
                        showStatus('üîç Found data in URL parameters! Processing...', 'loading');
                        localStorage.setItem('urlToMarkdownData', decoded);
                        setTimeout(() => checkForBookmarkletData(), 100);
                        return;
                    }
                } catch (e) {
                    console.log('üîç Failed to decode URL data with new method, trying simple atob:', e);
                    try {
                        const decoded = atob(encodedData);
                        const data = JSON.parse(decoded);
                        if (data.content || data.textContent) {
                            showStatus('üîç Found data in URL parameters (legacy format)! Processing...', 'loading');
                            localStorage.setItem('urlToMarkdownData', decoded);
                            setTimeout(() => checkForBookmarkletData(), 100);
                            return;
                        }
                    } catch (e2) {
                        console.log('üîç Both decoding methods failed:', e2);
                        showStatus('‚ùå URL data found but failed to decode: ' + e2.message, 'error');
                    }
                }
            }
            
            // If we came from bookmarklet but have no data, provide specific troubleshooting
            if ((fromBookmarklet || method) && Object.keys(localStorageContents).length === 0 && Object.keys(sessionStorageContents).length === 0 && !encodedData) {
                let troubleshootingHtml = '';
                
                if (method === 'clipboard') {
                    troubleshootingHtml = `
                        <div class="debug-info" style="margin-top: 15px; background: #e3f2fd; border-color: #2196f3;">
                            <strong>üìã Clipboard Transfer Active</strong><br><br>
                            The bookmarklet copied your content to the clipboard and opened this converter.<br><br>
                            <strong>If auto-paste didn't work:</strong><br>
                            ‚Ä¢ Go to the "Manual HTML" tab<br>
                            ‚Ä¢ Press Ctrl+V (or Cmd+V) to paste manually<br>
                            ‚Ä¢ Click "Convert HTML" to process<br><br>
                            <strong>Your content should be:</strong> ${expectedChars ? expectedChars + ' characters' : 'Unknown size'}
                        </div>
                    `;
                } else if (method === 'postmessage') {
                    troubleshootingHtml = `
                        <div class="debug-info" style="margin-top: 15px; background: #e3f2fd; border-color: #2196f3;">
                            <strong>üì° PostMessage Transfer Issues</strong><br><br>
                            The bookmarklet is using secure postMessage transfer, but no data was received yet.<br><br>
                            <strong>This is normal if:</strong><br>
                            ‚Ä¢ The transfer is still in progress (wait a moment)<br>
                            ‚Ä¢ The source window is still loading<br><br>
                            <strong>If it fails:</strong><br>
                            ‚Ä¢ Make sure popups are allowed<br>
                            ‚Ä¢ Keep the source page open during transfer<br>
                            ‚Ä¢ Try the bookmarklet again if it times out
                        </div>
                    `;
                } else {
                    troubleshootingHtml = `
                        <div class="debug-info" style="margin-top: 15px; background: #fff3cd; border-color: #ffeaa7;">
                            <strong>‚ö†Ô∏è Data Transfer Issue Detected</strong><br><br>
                            The bookmarklet successfully extracted ${expectedChars ? expectedChars + ' characters' : 'content'} using ${method || storageMethod || 'unknown method'}, but the data didn't arrive at the converter.<br><br>
                            <strong>Possible causes & solutions:</strong><br>
                            1. <strong>Browser security/privacy settings</strong> - Try a different browser or disable strict privacy mode<br>
                            2. <strong>Incognito/private mode</strong> - Switch to regular browsing mode<br>
                            3. <strong>Browser extension interference</strong> - Try disabling ad blockers or privacy extensions temporarily<br>
                            4. <strong>Timing issues</strong> - Try the extraction again<br><br>
                            <strong>Immediate workarounds:</strong><br>
                            ‚Ä¢ Try the extraction again - sometimes it works on second attempt<br>
                            ‚Ä¢ Use the Manual HTML tab to copy/paste the page source<br>
                            ‚Ä¢ Try a different browser (Chrome, Firefox, Safari, Edge)
                        </div>
                    `;
                }
                
                document.getElementById('statusDiv').innerHTML += troubleshootingHtml;
                
                if (method === 'clipboard') {
                    showStatus('üîÑ Clipboard transfer active. Check instructions above if auto-paste didn\'t work.', 'loading');
                } else if (method === 'postmessage') {
                    showStatus('üîÑ PostMessage transfer active. Waiting for data...', 'loading');
                } else {
                    showStatus('‚ùå Data transfer succeeded but content not received. Check troubleshooting guide above.', 'error');
                }
            }
            
            const dataFound = checkForBookmarkletData();
            if (!dataFound) {
                // Look for any keys that might contain our data
                const allKeys = [...Object.keys(localStorageContents), ...Object.keys(sessionStorageContents)];
                const potentialKeys = allKeys.filter(key => 
                    key.includes('urlToMarkdown') || 
                    key.includes('bookmark') || 
                    key.includes('extract') ||
                    key.includes('content') ||
                    key.includes('data')
                );
                
                if (potentialKeys.length > 0) {
                    showStatus('üîç Found potential data keys: ' + potentialKeys.join(', ') + '. Trying to process...', 'loading');
                    
                    // Try each potential key
                    for (const key of potentialKeys) {
                        const data = localStorage.getItem(key) || sessionStorage.getItem(key);
                        if (data && data.length > 50) { // Only try substantial data
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.content || parsed.textContent) {
                                    console.log('üîç Found valid data in key:', key);
                                    localStorage.setItem('urlToMarkdownData', data);
                                    setTimeout(() => checkForBookmarkletData(), 100);
                                    return;
                                }
                            } catch (e) {
                                console.log('üîç Key', key, 'does not contain valid JSON:', e.message);
                            }
                        }
                    }
                    showStatus('‚ùå Found potential keys but none contained valid content data.', 'error');
                } else {
                    if (fromBookmarklet) {
                        showStatus('‚ùå Bookmarklet executed but failed to extract or store content. Check the troubleshooting guide above.', 'error');
                    } else {
                        showStatus('‚ùå No bookmarklet data found. Please click the bookmarklet on the source page first, then come back to this tool.', 'error');
                    }
                }
            }
        }

        function tryDifferentExtraction() {
            showStatus('üîÑ Attempting alternative data recovery...', 'loading');
            
            // Try to check multiple storage locations
            const allStorageKeys = ['urlToMarkdownData', 'urlToMarkdownBackup', 'bookmarkletData', 'extractedContent'];
            
            for (const storageType of ['localStorage', 'sessionStorage']) {
                for (const key of allStorageKeys) {
                    try {
                        const storage = storageType === 'localStorage' ? localStorage : sessionStorage;
                        const data = storage.getItem(key);
                        if (data && data.length > 100) {
                            console.log(`üîç Found data in ${storageType}.${key}`);
                            try {
                                const parsed = JSON.parse(data);
                                if (parsed.content || parsed.textContent) {
                                    showStatus(`‚úÖ Found backup data in ${storageType}.${key}! Processing...`, 'success');
                                    
                                    // Clean up found data
                                    storage.removeItem(key);
                                    
                                    processBookmarkletData(parsed);
                                    return;
                                }
                            } catch (e) {
                                console.log(`üîç Data in ${key} is not valid JSON`);
                            }
                        }
                    } catch (e) {
                        console.log(`üîç Error checking ${storageType}.${key}:`, e);
                    }
                }
            }
            
            // Check URL parameters as well
            const urlParams = new URLSearchParams(window.location.search);
            const encodedData = urlParams.get('data');
            if (encodedData) {
                try {
                    const decoded = decodeURIComponent(escape(atob(encodedData)));
                    const parsed = JSON.parse(decoded);
                    if (parsed.content || parsed.textContent) {
                        showStatus('‚úÖ Found data in URL parameters! Processing...', 'success');
                        processBookmarkletData(parsed);
                        return;
                    }
                } catch (e) {
                    console.log('üîç Failed to decode URL data:', e);
                }
            }
            
            showStatus('‚ùå No backup data found. Please try the Manual HTML method or run the bookmarklet again.', 'error');
        }

        function showManualInstructions() {
            const instructionsHtml = `
                <div class="debug-info" style="margin-top: 15px; background: #e8f5e8; border-color: #4caf50;">
                    <strong>üìñ Manual Data Recovery Instructions</strong><br><br>
                    Since automatic data transfer failed, here's how to extract content manually:<br><br>
                    <strong>Method 1 - Page Source:</strong><br>
                    1. Go back to the page you want to convert<br>
                    2. Right-click ‚Üí "View Page Source" (or press Ctrl+U / Cmd+U)<br>
                    3. Copy ALL the HTML code (Ctrl+A, then Ctrl+C)<br>
                    4. Return here and paste it in the "Manual HTML" tab<br><br>
                    <strong>Method 2 - Try Different Browser:</strong><br>
                    ‚Ä¢ Chrome, Firefox, Edge, or Safari may handle storage differently<br>
                    ‚Ä¢ Try the bookmarklet in a different browser<br><br>
                    <strong>Method 3 - Direct URL (if public):</strong><br>
                    ‚Ä¢ If the page doesn't require login, use the "Direct URL" tab<br>
                    ‚Ä¢ Copy the page URL and paste it there
                </div>
            `;
            document.getElementById('statusDiv').innerHTML += instructionsHtml;
        }

        function testStorage() {
            console.log('üîç Testing storage system...');
            showStatus('üîÑ Testing storage system...', 'loading');
            
            try {
                // Test localStorage
                const testData = {
                    title: 'Storage Test',
                    content: '<p>This is a test of the storage system</p>',
                    textContent: 'This is a test of the storage system',
                    url: window.location.href,
                    timestamp: Date.now(),
                    source: 'storage-test'
                };
                
                const testDataString = JSON.stringify(testData);
                
                // Test basic localStorage
                localStorage.setItem('storageTest', testDataString);
                const retrieved = localStorage.getItem('storageTest');
                
                if (retrieved === testDataString) {
                    console.log('‚úÖ localStorage test passed');
                    
                    // Test our specific key
                    localStorage.setItem('urlToMarkdownData', testDataString);
                    const specificRetrieved = localStorage.getItem('urlToMarkdownData');
                    
                    if (specificRetrieved === testDataString) {
                        console.log('‚úÖ urlToMarkdownData key test passed');
                        
                        // Now test the detection system
                        showStatus('‚úÖ Storage system working! Testing detection...', 'success');
                        
                        setTimeout(() => {
                            const detected = checkForBookmarkletData();
                            if (detected) {
                                showStatus('‚úÖ Storage and detection system fully working!', 'success');
                            } else {
                                showStatus('‚ùå Storage works but detection failed', 'error');
                            }
                        }, 500);
                        
                    } else {
                        showStatus('‚ùå urlToMarkdownData key storage failed', 'error');
                    }
                } else {
                    showStatus('‚ùå Basic localStorage test failed', 'error');
                }
                
                // Clean up test data
                localStorage.removeItem('storageTest');
                
            } catch (error) {
                console.error('üîç Storage test error:', error);
                showStatus('‚ùå Storage test failed: ' + error.message, 'error');
            }
        }

        function copyBookmarkletCode() {
            const bookmarkletLink = document.getElementById('bookmarkletLink');
            const bookmarkletCode = bookmarkletLink.href;
            
            navigator.clipboard.writeText(bookmarkletCode).then(() => {
                showStatus('‚úÖ Bookmarklet code copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = bookmarkletCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('‚úÖ Bookmarklet code copied to clipboard!', 'success');
            });
        }

        function testBookmarklet() {
            try {
                // Enhanced content extraction logic matching the bookmarklet
                const aggressiveContentExtract = () => {
                    console.log('üîç Using aggressive content extraction');
                    const allElements = document.querySelectorAll('div, p, article, section, main, [role=main]');
                    let bestElement = null;
                    let maxTextLength = 0;
                    let contentElements = [];

                    for (const el of allElements) {
                        const text = (el.textContent || el.innerText || '').trim();
                        if (text.length > 100 && text.length > maxTextLength) {
                            const childDivs = el.querySelectorAll('div').length;
                            const childPs = el.querySelectorAll('p').length;
                            const totalChildren = el.children.length;
                            
                            // Look for elements with substantial content structure
                            if (childDivs + childPs > 2 || totalChildren > 3 || text.length > 500) {
                                bestElement = el;
                                maxTextLength = text.length;
                                contentElements.push({
                                    element: el,
                                    textLength: text.length,
                                    tag: el.tagName,
                                    class: el.className,
                                    id: el.id
                                });
                            }
                        }
                    }

                    console.log('üîç Content candidates found:', contentElements.slice(0, 5));

                    if (bestElement) {
                        const title = document.title || 
                                    bestElement.querySelector('h1,h2,h3')?.textContent || 
                                    document.querySelector('h1,h2,h3')?.textContent || 
                                    'Extracted Content';
                        console.log('üîç Selected best element:', {
                            tag: bestElement.tagName,
                            class: bestElement.className,
                            textLength: maxTextLength
                        });
                        return {
                            title: title.trim(),
                            content: bestElement.innerHTML,
                            textContent: bestElement.textContent || bestElement.innerText || ''
                        };
                    }

                    // Final fallback to body if nothing substantial found
                    const fullBodyText = (document.body.textContent || document.body.innerText || '').trim();
                    if (fullBodyText.length > 100) {
                        console.log('üîç Using full body as fallback', { textLength: fullBodyText.length });
                        return {
                            title: document.title || 'Full Page Content',
                            content: document.body.innerHTML,
                            textContent: fullBodyText
                        };
                    }

                    throw new Error('Could not find any substantial content on this page. Page may be empty or content may be loading.');
                };

                // Check if this is a Google Site
                const isGoogleSite = window.location.hostname.includes('sites.google.com') || 
                                   document.querySelector('.sites-header-cell-buffer') || 
                                   document.querySelector('[data-is-preview-mode]') ||
                                   document.querySelector('.sites-layout') ||
                                   document.querySelector('.TeI8t') ||
                                   document.title.includes('Google Sites');

                let article;
                
                if (isGoogleSite) {
                    console.log('üîç Detected Google Site, using Google Sites extraction');
                    // Google Sites specific extraction with comprehensive selectors
                    const selectors = [
                        '.jZfhZe', '.VEXWte', '[data-is-preview-mode] .VEXWte',
                        '[role=main]', 'main', '.sites-layout__main',
                        '.sites-canvas-main', '.sites-page-content', '.TeI8t',
                        '.XuV9uc', '.sites-embed-content-body', '.sites-page-wrapper',
                        '.sites-page-main', '.DM7qOc', '.TQc1id', '.CwaK9',
                        '.Fj6HLe div', '.oKdM2c', '.GJVK5c'
                    ];
                    
                    let main = null;
                    let foundSelector = '';
                    
                    for (const selector of selectors) {
                        main = document.querySelector(selector);
                        if (main) {
                            const text = (main.textContent || main.innerText || '').trim();
                            if (text.length > 50) {
                                foundSelector = selector;
                                console.log('üîç Found Google Sites content with selector:', selector, 'Text length:', text.length);
                                break;
                            } else {
                                console.log('üîç Selector found but insufficient content:', selector, 'Text length:', text.length);
                                main = null;
                            }
                        }
                    }
                    
                    if (!main) {
                        console.log('üîç No specific Google Sites selectors worked, trying aggressive extraction');
                        article = aggressiveContentExtract();
                    } else {
                        const title = document.title || 
                                    document.querySelector('h1,h2,h3,.zfr3Q')?.textContent || 
                                    'Google Site';
                        article = {
                            title: title.trim(),
                            content: main.innerHTML,
                            textContent: main.textContent || main.innerText || ''
                        };
                    }
                } else if (typeof window.Readability !== 'undefined') {
                    // Try Readability first for non-Google sites
                    try {
                        const documentClone = document.cloneNode(true);
                        const reader = new Readability(documentClone);
                        const readabilityResult = reader.parse();
                        
                        if (readabilityResult && readabilityResult.content && readabilityResult.textContent.trim().length > 50) {
                            article = readabilityResult;
                        } else {
                            throw new Error('Readability returned insufficient content');
                        }
                    } catch (e) {
                        console.warn('üîç Readability failed, using aggressive extraction:', e);
                        article = aggressiveContentExtract();
                    }
                } else {
                    // Use aggressive extraction when Readability is not available
                    console.log('üîç Readability not available, using aggressive extraction');
                    article = aggressiveContentExtract();
                }

                if (article && article.content && article.textContent && article.textContent.trim().length > 20) {
                    const testData = {
                        title: 'TEST: ' + article.title,
                        content: article.content,
                        textContent: article.textContent,
                        url: window.location.href,
                        timestamp: Date.now(),
                        source: 'test',
                        pageType: isGoogleSite ? 'google-site' : 'generic',
                        debug: {
                            originalTextLength: article.textContent.length,
                            isGoogleSite,
                            hostname: window.location.hostname
                        }
                    };

                    localStorage.setItem('urlToMarkdownData', JSON.stringify(testData));
                    showStatus('‚úÖ Test successful! Processing content...', 'success');
                    
                    setTimeout(() => {
                        checkForBookmarkletData();
                    }, 1000);
                } else {
                    showStatus('‚ùå Test failed: Could not extract sufficient content', 'error');
                }
            } catch (error) {
                const errorMsg = error?.message || error?.toString() || 'Unknown error occurred';
                showStatus(`‚ùå Test failed: ${errorMsg}`, 'error');
                console.error('üîç Test error:', error);
            }
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(extractedContent);
                showStatus('‚úÖ Markdown copied to clipboard!', 'success');
            } catch (err) {
                // Fallback selection method
                const textarea = document.getElementById('markdownOutput');
                textarea.select();
                document.execCommand('copy');
                showStatus('‚úÖ Markdown copied to clipboard!', 'success');
            }
        }

        function downloadMarkdown() {
            const blob = new Blob([extractedContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Generate filename
            let filename = 'article.md';
            if (originalUrl) {
                try {
                    const urlObj = new URL(originalUrl);
                    const pathName = urlObj.pathname.split('/').pop() || 'article';
                    filename = pathName.replace(/\.[^/.]+$/, '') + '.md';
                } catch (e) {
                    // Use default filename if URL parsing fails
                }
            }
            
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('‚úÖ Markdown file downloaded!', 'success');
        }

        async function shareMarkdown() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Converted Markdown',
                        text: extractedContent,
                    });
                    showStatus('‚úÖ Shared successfully!', 'success');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        await copyToClipboard();
                    }
                }
            } else {
                await copyToClipboard();
            }
        }

        // Check if Web Share API is supported
        if (!navigator.share) {
            const shareBtn = document.getElementById('shareBtn');
            shareBtn.textContent = 'üìã Copy';
            shareBtn.onclick = copyToClipboard;
        }

        // Auto-clear status after 5 seconds for success messages
        let statusTimeout;
        const originalShowStatus = showStatus;
        showStatus = async function(message, type = 'loading') {
            clearTimeout(statusTimeout);
            await originalShowStatus(message, type);
            
            if (type === 'success' || type === 'bookmarklet') {
                statusTimeout = setTimeout(clearStatus, 5000);
            }
        };
    </script>
</body>
</html>