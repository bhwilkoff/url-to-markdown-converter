<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL to Markdown Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/readability/0.4.4/Readability.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.2/turndown.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f7fafc;
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #718096;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f7fafc;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
        }

        .bookmarklet-section {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
        }

        .bookmarklet-section h3 {
            color: white;
            margin-bottom: 15px;
        }

        .bookmarklet-drag-area {
            background: rgba(255, 255, 255, 0.15);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .bookmarklet-drag-area:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .bookmarklet-link {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white !important;
            text-decoration: none !important;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: grab;
        }

        .bookmarklet-link:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .bookmarklet-link:active {
            cursor: grabbing;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .bookmarklet-section label {
            color: white;
        }

        input[type="url"], textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="url"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        .btn-white {
            background: white;
            color: #2d3748;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-white:hover {
            background: #f7fafc;
            transform: translateY(-2px);
        }

        .output-section {
            margin-top: 30px;
            padding: 25px;
            background: #1a202c;
            border-radius: 15px;
            position: relative;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .output-title {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .output-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        #markdownOutput {
            background: #2d3748;
            color: #e2e8f0;
            border: none;
            border-radius: 8px;
            padding: 20px;
            width: 100%;
            min-height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.loading {
            background: #bee3f8;
            color: #2a69ac;
            border: 1px solid #90cdf4;
        }

        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .feature-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .feature-desc {
            color: #718096;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .cors-info {
            background: #fef5e7;
            border: 1px solid #f6ad55;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .cors-info h4 {
            color: #c05621;
            margin-bottom: 8px;
        }

        .cors-info p {
            color: #744210;
            font-size: 14px;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }

            .output-header {
                flex-direction: column;
                gap: 15px;
            }

            .output-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ URL to Markdown Converter</h1>
        <p class="subtitle">Convert any webpage to clean, formatted Markdown instantly - including authenticated pages!</p>

        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-title">üîê Authenticated Access</div>
                <div class="feature-desc">Use the bookmarklet to extract content from login-protected pages while you're logged in</div>
            </div>
            <div class="feature-card">
                <div class="feature-title">üåê Smart Content Extraction</div>
                <div class="feature-desc">Uses Mozilla's Readability to extract main content while filtering out ads, navigation, and clutter</div>
            </div>
            <div class="feature-card">
                <div class="feature-title">üìù GitHub-Compatible Markdown</div>
                <div class="feature-desc">Generates clean Markdown with tables, task lists, and all GitHub Flavored Markdown features</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="bookmarklet">üîê Bookmarklet (Best for Auth)</div>
            <div class="tab" data-tab="direct">üåê Direct URL</div>
            <div class="tab" data-tab="manual">üìÑ Manual HTML</div>
        </div>

        <!-- Bookmarklet Tab -->
        <div class="tab-content active" id="bookmarklet-tab">
            <div class="input-section bookmarklet-section">
                <h3>üîê Extract from Authenticated Pages</h3>
                <p style="margin-bottom: 20px; opacity: 0.9;">This bookmarklet works on ANY webpage - including those requiring login! Perfect for private dashboards, social media, internal tools, Google Sites, and more.</p>
                
                <div class="bookmarklet-drag-area">
                    <p style="margin-bottom: 15px; font-size: 18px; font-weight: 600;">üìå Drag this to your bookmarks bar:</p>
                    <a href="javascript:(function(){if(window.urlToMarkdownBookmarklet){alert('Bookmarklet already running!');return;}window.urlToMarkdownBookmarklet=true;try{const isGoogleSite=window.location.hostname.includes('sites.google.com')||document.querySelector('.sites-header-cell-buffer')||document.querySelector('[data-is-preview-mode]')||document.querySelector('.sites-layout')||document.title.includes('Google Sites');let article;if(isGoogleSite){const selectors=['.jZfhZe','.VEXWte','[data-is-preview-mode] .VEXWte','[role=main]','main','.sites-layout__main','.sites-canvas-main','.sites-page-content','.TeI8t','.XuV9uc'];let main=null;for(const sel of selectors){main=document.querySelector(sel);if(main&&(main.textContent||'').trim().length>50){break;}main=null;}if(!main){main=document.body;}article={title:document.title||'Google Site',content:main.innerHTML,textContent:main.textContent||main.innerText||''};}else{const content=document.querySelector('article')||document.querySelector('[role=main]')||document.querySelector('main')||document.body;article={title:document.title||'Extracted Content',content:content.innerHTML,textContent:content.textContent||content.innerText||''};}if(!article.textContent||article.textContent.trim().length<20){throw new Error('No content found ('+article.textContent.trim().length+' chars)');}const data={title:article.title,content:article.content,textContent:article.textContent,url:window.location.href,timestamp:Date.now(),source:'bookmarklet-clipboard',pageType:isGoogleSite?'google-site':'generic'};const chars=data.textContent.length;const dataStr=JSON.stringify(data);navigator.clipboard.writeText(dataStr).then(()=>{const proceed=confirm('Content extracted ('+chars+' chars) and copied to clipboard!\\n\\nClick OK to open converter - it will automatically process your content.');if(proceed){window.open('https://bhwilkoff.github.io/url-to-markdown-converter/?method=clipboard&chars='+chars,'_blank');}}).catch(err=>{alert('Clipboard access failed. Please use the Manual HTML tab and paste manually.\\n\\nExtracted '+chars+' characters.');});}catch(e){alert('Error: '+e.message);}})();" class="bookmarklet-link" id="bookmarkletLink">üìÑ‚ûúüìù Extract to Markdown</a>
                </div>

                <div class="instructions">
                    <h4 style="margin-bottom: 15px; color: white;">üìã How to use:</h4>
                    <ol style="color: rgba(255,255,255,0.9);">
                        <li><strong>Drag the button above</strong> to your browser's bookmarks bar</li>
                        <li><strong>Visit any webpage</strong> (public or requiring login)</li>
                        <li><strong>Click the bookmarklet</strong> in your bookmarks bar</li>
                        <li><strong>Content automatically processes</strong> in the converter</li>
                    </ol>
                    
                    <p style="margin-top: 15px; opacity: 0.9;"><strong>üí° Works on:</strong> LinkedIn, Facebook, private dashboards, internal tools, Notion pages, Google Sites, and any other authenticated content!</p>
                </div>
            </div>
        </div>

        <!-- Direct URL Tab -->
        <div class="tab-content" id="direct-tab">
            <div class="input-section">
                <div class="input-group">
                    <label for="urlInput">üìé Website URL</label>
                    <input type="url" id="urlInput" placeholder="https://example.com/article" />
                    <div class="button-group">
                        <button class="btn-primary" onclick="pasteFromClipboard()">
                            üìã Paste from Clipboard & Convert
                        </button>
                        <button class="btn-secondary" onclick="convertFromURL()">
                            üîÑ Convert URL
                        </button>
                    </div>
                </div>

                <div class="cors-info">
                    <h4>üîí Limitations of Direct URL Method</h4>
                    <p><strong>‚úÖ Works for:</strong> Public websites, most blogs, news sites, documentation</p>
                    <p><strong>‚ùå Won't work for:</strong> Login-required pages, some modern SPAs, CORS-protected sites</p>
                    <p><strong>üí° For authenticated content:</strong> Use the Bookmarklet tab above!</p>
                </div>
            </div>
        </div>

        <!-- Manual HTML Tab -->
        <div class="tab-content" id="manual-tab">
            <div class="input-section">
                <div class="input-group">
                    <label for="htmlInput">üìÑ Raw HTML Source Code</label>
                    <textarea id="htmlInput" placeholder="Paste raw HTML source code here for authenticated pages or when URL fetch fails..."></textarea>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="convertFromHTML()">
                            üîÑ Convert HTML
                        </button>
                        <button class="btn-secondary" onclick="clearHTML()">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>
                <div class="cors-info">
                    <h4>üìã How to get HTML source:</h4>
                    <p>1. Visit the page in your browser while logged in</p>
                    <p>2. Right-click ‚Üí "View Page Source" or press Ctrl+U (Cmd+U on Mac)</p>
                    <p>3. Copy all the HTML and paste it above</p>
                </div>
            </div>
        </div>

        <div id="statusDiv"></div>

        <div class="output-section hidden" id="outputSection">
            <div class="output-header">
                <div class="output-title">üìù Markdown Output</div>
                <div class="output-actions">
                    <button class="btn-small btn-secondary" onclick="copyToClipboard()">
                        üìã Copy
                    </button>
                    <button class="btn-small btn-success" onclick="downloadMarkdown()">
                        üíæ Download
                    </button>
                    <button class="btn-small btn-primary" onclick="shareMarkdown()" id="shareBtn">
                        üîó Share
                    </button>
                </div>
            </div>
            <textarea id="markdownOutput" readonly></textarea>
        </div>
    </div>

    <script>
        let extractedContent = '';
        let originalUrl = '';

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });

        // Initialize turndown with GFM extensions
        const turndownService = new TurndownService({
            headingStyle: 'atx',
            codeBlockStyle: 'fenced',
            fence: '```',
            emDelimiter: '*',
            strongDelimiter: '**',
            linkStyle: 'inlined',
            linkReferenceStyle: 'full',
            br: '',
            preformattedCode: false,
            blankReplacement: function (content, node) {
                return node.isBlock ? '\n\n' : '';
            },
            keepReplacement: function (content, node) {
                return node.isBlock ? '\n\n' + node.outerHTML + '\n\n' : node.outerHTML;
            },
            defaultReplacement: function (content, node) {
                return node.isBlock ? '\n\n' + content + '\n\n' : content;
            }
        });

        // Add GFM extensions
        turndownService.addRule('strikethrough', {
            filter: ['del', 's', 'strike'],
            replacement: function (content) {
                return '~~' + content + '~~';
            }
        });

        turndownService.addRule('taskList', {
            filter: function (node) {
                return node.type === 'checkbox' && node.parentNode.nodeName === 'LI';
            },
            replacement: function (content, node) {
                return (node.checked ? '[x]' : '[ ]') + ' ';
            }
        });

        turndownService.addRule('table', {
            filter: 'table',
            replacement: function (content, node) {
                const rows = Array.from(node.querySelectorAll('tr'));
                let markdown = '\n';
                
                rows.forEach((row, index) => {
                    const cells = Array.from(row.querySelectorAll('td, th'));
                    const rowContent = cells.map(cell => cell.textContent.trim()).join(' | ');
                    markdown += '| ' + rowContent + ' |\n';
                    
                    if (index === 0 && row.querySelector('th')) {
                        markdown += '|' + cells.map(() => ' --- ').join('|') + '|\n';
                    }
                });
                
                return markdown + '\n';
            }
        });

        // Check for bookmarklet data on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkForClipboardMethod();
            }, 100);
        });

        // Check for clipboard method
        function checkForClipboardMethod() {
            const urlParams = new URLSearchParams(window.location.search);
            const method = urlParams.get('method');
            
            if (method === 'clipboard') {
                const expectedChars = urlParams.get('chars');
                showStatus(`üîÑ Processing clipboard content (${expectedChars} characters)...`, 'loading');
                
                setTimeout(async () => {
                    try {
                        const clipboardText = await navigator.clipboard.readText();
                        
                        if (clipboardText && clipboardText.length > 100) {
                            // Try to parse as JSON (bookmarklet data)
                            try {
                                const parsed = JSON.parse(clipboardText);
                                if (parsed.content && parsed.textContent && parsed.source && parsed.source.includes('bookmarklet')) {
                                    showStatus('‚úÖ Content auto-processed from clipboard!', 'success');
                                    setTimeout(() => {
                                        processBookmarkletData(parsed);
                                    }, 500);
                                    return;
                                }
                            } catch (e) {
                                // Not JSON, treat as raw HTML
                                document.getElementById('htmlInput').value = clipboardText;
                                document.querySelector('[data-tab="manual"]').click();
                                showStatus('‚úÖ Content pasted into Manual HTML tab! Click "Convert HTML" to process.', 'success');
                                return;
                            }
                        }
                        
                        throw new Error('No substantial content found in clipboard');
                        
                    } catch (error) {
                        showStatus('‚ùå Could not read from clipboard. Please paste manually in the Manual HTML tab.', 'error');
                        document.querySelector('[data-tab="manual"]').click();
                    }
                }, 1000);
                
                return true;
            }
            
            return false;
        }

        async function processBookmarkletData(data) {
            try {
                originalUrl = data.url;
                
                const pageTypeText = data.pageType === 'google-site' ? ' (Google Site)' : '';
                showStatus(`üîÑ Converting content to Markdown${pageTypeText}...`, 'loading');

                // Convert to Markdown
                let markdown = '';
                
                // Add title if available
                if (data.title && data.title.trim()) {
                    markdown += `# ${data.title.trim()}\n\n`;
                }

                // Add source URL if available
                if (data.url) {
                    markdown += `> Source: [${data.url}](${data.url})\n`;
                    markdown += `> Extracted: ${new Date(data.timestamp).toLocaleString()}`;
                    if (data.pageType) {
                        markdown += ` (${data.pageType})`;
                    }
                    markdown += `\n\n`;
                }

                // Convert content
                const contentMarkdown = turndownService.turndown(data.content);
                markdown += contentMarkdown;

                // Clean up the markdown
                markdown = markdown
                    .replace(/\n{3,}/g, '\n\n') // Remove excessive newlines
                    .replace(/^\s+/gm, '') // Remove leading whitespace
                    .trim();

                extractedContent = markdown;
                
                // Display the result
                document.getElementById('markdownOutput').value = markdown;
                document.getElementById('outputSection').classList.remove('hidden');
                
                const successMessage = data.pageType === 'google-site' ? 
                    `‚úÖ Successfully converted Google Site content! Generated ${markdown.length} characters of Markdown.` :
                    `‚úÖ Successfully converted! Generated ${markdown.length} characters of Markdown.`;
                
                showStatus(successMessage, 'success');
                
                // Scroll to output
                document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                showStatus(`‚ùå Error processing content: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearStatus() {
            document.getElementById('statusDiv').innerHTML = '';
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                const urlInput = document.getElementById('urlInput');
                
                if (text && (text.startsWith('http://') || text.startsWith('https://'))) {
                    urlInput.value = text;
                    await convertFromURL();
                } else {
                    showStatus('‚ùå No valid URL found in clipboard. Please paste a URL manually.', 'error');
                }
            } catch (err) {
                showStatus('‚ùå Could not access clipboard. Please paste the URL manually.', 'error');
            }
        }

        async function convertFromURL() {
            const url = document.getElementById('urlInput').value.trim();
            
            if (!url) {
                showStatus('‚ùå Please enter a URL', 'error');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showStatus('‚ùå Please enter a valid URL starting with http:// or https://', 'error');
                return;
            }

            originalUrl = url;
            showStatus('üîÑ Fetching webpage...', 'loading');

            try {
                // Try direct fetch first
                const response = await fetch(url, {
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const html = await response.text();
                await processHTML(html, url);

            } catch (error) {
                // Try CORS proxy as fallback
                try {
                    showStatus('üîÑ Trying alternative method...', 'loading');
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Proxy failed: ${response.status}`);
                    }

                    const html = await response.text();
                    await processHTML(html, url);

                } catch (proxyError) {
                    showStatus(`‚ùå Could not fetch URL. For authenticated content, please use the Bookmarklet tab!`, 'error');
                }
            }
        }

        async function convertFromHTML() {
            const html = document.getElementById('htmlInput').value.trim();
            
            if (!html) {
                showStatus('‚ùå Please paste HTML content', 'error');
                return;
            }

            showStatus('üîÑ Processing HTML...', 'loading');
            await processHTML(html, 'Manual HTML Input');
        }

        function clearHTML() {
            document.getElementById('htmlInput').value = '';
            clearStatus();
        }

        async function processHTML(html, source) {
            try {
                // Create a DOM parser
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Check if we got valid content
                if (!doc.body || doc.body.children.length === 0) {
                    throw new Error('Could not parse HTML content');
                }

                showStatus('üîÑ Extracting main content...', 'loading');

                // Try to use Readability for content extraction
                let article;
                try {
                    const readabilityDoc = doc.cloneNode(true);
                    const reader = new Readability(readabilityDoc);
                    article = reader.parse();
                } catch (readabilityError) {
                    article = {
                        title: doc.title || 'Untitled',
                        content: doc.body.innerHTML,
                        textContent: doc.body.textContent,
                        length: doc.body.textContent.length
                    };
                }

                if (!article || !article.content) {
                    throw new Error('Could not extract content from the page');
                }

                showStatus('üîÑ Converting to Markdown...', 'loading');

                // Convert to Markdown
                let markdown = '';
                
                // Add title if available
                if (article.title && article.title.trim()) {
                    markdown += `# ${article.title.trim()}\n\n`;
                }

                // Add source URL if available
                if (originalUrl && originalUrl !== 'Manual HTML Input') {
                    markdown += `> Source: [${originalUrl}](${originalUrl})\n\n`;
                }

                // Convert content
                const contentMarkdown = turndownService.turndown(article.content);
                markdown += contentMarkdown;

                // Clean up the markdown
                markdown = markdown
                    .replace(/\n{3,}/g, '\n\n') // Remove excessive newlines
                    .replace(/^\s+/gm, '') // Remove leading whitespace
                    .trim();

                extractedContent = markdown;
                
                // Display the result
                document.getElementById('markdownOutput').value = markdown;
                document.getElementById('outputSection').classList.remove('hidden');
                
                showStatus(`‚úÖ Successfully converted! Generated ${markdown.length} characters of Markdown.`, 'success');
                
                // Scroll to output
                document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                showStatus(`‚ùå Error processing content: ${error.message}`, 'error');
            }
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(extractedContent);
                showStatus('‚úÖ Markdown copied to clipboard!', 'success');
            } catch (err) {
                // Fallback selection method
                const textarea = document.getElementById('markdownOutput');
                textarea.select();
                document.execCommand('copy');
                showStatus('‚úÖ Markdown copied to clipboard!', 'success');
            }
        }

        function downloadMarkdown() {
            const blob = new Blob([extractedContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Generate filename
            let filename = 'article.md';
            if (originalUrl) {
                try {
                    const urlObj = new URL(originalUrl);
                    const pathName = urlObj.pathname.split('/').pop() || 'article';
                    filename = pathName.replace(/\.[^/.]+$/, '') + '.md';
                } catch (e) {
                    // Use default filename if URL parsing fails
                }
            }
            
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('‚úÖ Markdown file downloaded!', 'success');
        }

        async function shareMarkdown() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Converted Markdown',
                        text: extractedContent,
                    });
                    showStatus('‚úÖ Shared successfully!', 'success');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        await copyToClipboard();
                    }
                }
            } else {
                await copyToClipboard();
            }
        }

        // Check if Web Share API is supported
        if (!navigator.share) {
            const shareBtn = document.getElementById('shareBtn');
            shareBtn.textContent = 'üìã Copy';
            shareBtn.onclick = copyToClipboard;
        }

        // Auto-clear status after 5 seconds for success messages
        let statusTimeout;
        const originalShowStatus = showStatus;
        showStatus = function(message, type = 'loading') {
            clearTimeout(statusTimeout);
            originalShowStatus(message, type);
            
            if (type === 'success') {
                statusTimeout = setTimeout(clearStatus, 5000);
            }
        };
    </script>
</body>
</html>