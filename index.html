<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL to Markdown Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsdom/20.0.3/jsdom.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/readability/0.4.4/Readability.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.2/turndown.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f7fafc;
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #718096;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f7fafc;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
        }

        .bookmarklet-section {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
        }

        .bookmarklet-section h3 {
            color: white;
            margin-bottom: 15px;
        }

        .bookmarklet-drag-area {
            background: rgba(255, 255, 255, 0.15);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .bookmarklet-drag-area:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .bookmarklet-link {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white !important;
            text-decoration: none !important;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: grab;
        }

        .bookmarklet-link:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .bookmarklet-link:active {
            cursor: grabbing;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .bookmarklet-section label {
            color: white;
        }

        input[type="url"], textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="url"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        .btn-white {
            background: white;
            color: #2d3748;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-white:hover {
            background: #f7fafc;
            transform: translateY(-2px);
        }

        .output-section {
            margin-top: 30px;
            padding: 25px;
            background: #1a202c;
            border-radius: 15px;
            position: relative;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .output-title {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .output-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        #markdownOutput {
            background: #2d3748;
            color: #e2e8f0;
            border: none;
            border-radius: 8px;
            padding: 20px;
            width: 100%;
            min-height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.loading {
            background: #bee3f8;
            color: #2a69ac;
            border: 1px solid #90cdf4;
        }

        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .status.bookmarklet {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .feature-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .feature-desc {
            color: #718096;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .cors-info {
            background: #fef5e7;
            border: 1px solid #f6ad55;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .cors-info h4 {
            color: #c05621;
            margin-bottom: 8px;
        }

        .cors-info p {
            color: #744210;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .bookmarklet-detected {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .bookmarklet-detected h3 {
            margin-bottom: 10px;
        }

        .debug-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 12px;
            color: #4a5568;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }

            .output-header {
                flex-direction: column;
                gap: 15px;
            }

            .output-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 URL to Markdown Converter</h1>
        <p class="subtitle">Convert any webpage to clean, formatted Markdown instantly - including authenticated pages!</p>

        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-title">🔐 Authenticated Access</div>
                <div class="feature-desc">Use the bookmarklet to extract content from login-protected pages while you're logged in</div>
            </div>
            <div class="feature-card">
                <div class="feature-title">🌐 Smart Content Extraction</div>
                <div class="feature-desc">Uses Mozilla's Readability to extract main content while filtering out ads, navigation, and clutter</div>
            </div>
            <div class="feature-card">
                <div class="feature-title">📝 GitHub-Compatible Markdown</div>
                <div class="feature-desc">Generates clean Markdown with tables, task lists, and all GitHub Flavored Markdown features</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="bookmarklet">🔐 Bookmarklet (Best for Auth)</div>
            <div class="tab" data-tab="direct">🌐 Direct URL</div>
            <div class="tab" data-tab="manual">📄 Manual HTML</div>
        </div>

        <!-- Bookmarklet Tab -->
        <div class="tab-content active" id="bookmarklet-tab">
            <div class="input-section bookmarklet-section">
                <h3>🔐 Extract from Authenticated Pages</h3>
                <p style="margin-bottom: 20px; opacity: 0.9;">This bookmarklet works on ANY webpage - including those requiring login! Perfect for private dashboards, social media, internal tools, Google Sites, and more.</p>
                
                <div class="bookmarklet-drag-area">
                    <p style="margin-bottom: 15px; font-size: 18px; font-weight: 600;">📌 Drag this to your bookmarks bar:</p>
                    <a href="javascript:(function(){if(window.urlToMarkdownBookmarklet){return;}window.urlToMarkdownBookmarklet=true;const debug=(msg,obj)=>{console.log('🔍 Bookmarklet Debug:',msg,obj||'');};debug('Starting extraction on:',window.location.href);const aggressiveContentExtract=()=>{debug('Using aggressive content extraction');const allElements=document.querySelectorAll('div, p, article, section, main, [role=main]');let bestElement=null;let maxTextLength=0;let contentElements=[];for(const el of allElements){const text=(el.textContent||el.innerText||'').trim();if(text.length>100&&text.length>maxTextLength){const childDivs=el.querySelectorAll('div').length;const childPs=el.querySelectorAll('p').length;const totalChildren=el.children.length;if(childDivs+childPs>2||totalChildren>3||text.length>500){bestElement=el;maxTextLength=text.length;contentElements.push({element:el,textLength:text.length,tag:el.tagName,class:el.className,id:el.id});}}}debug('Content candidates found:',contentElements.slice(0,5));if(bestElement){const title=document.title||bestElement.querySelector('h1,h2,h3')?.textContent||document.querySelector('h1,h2,h3')?.textContent||'Extracted Content';debug('Selected best element:',{tag:bestElement.tagName,class:bestElement.className,textLength:maxTextLength});return{title:title.trim(),content:bestElement.innerHTML,textContent:bestElement.textContent||bestElement.innerText||''};}const fullBodyText=(document.body.textContent||document.body.innerText||'').trim();if(fullBodyText.length>100){debug('Using full body as fallback',{textLength:fullBodyText.length});return{title:document.title||'Full Page Content',content:document.body.innerHTML,textContent:fullBodyText};}throw new Error('Could not find any substantial content on this page. Page may be empty or content may be loading.');};const googleSitesExtract=()=>{debug('Using Google Sites extraction');const selectors=['.jZfhZe','.VEXWte','[data-is-preview-mode] .VEXWte','[role=main]','main','.sites-layout__main','.sites-canvas-main','.sites-page-content','.TeI8t','.XuV9uc','.sites-embed-content-body','.sites-page-wrapper','.sites-page-main','.DM7qOc','.TQc1id','.CwaK9','.Fj6HLe div','.oKdM2c','.GJVK5c'];let main=null;let foundSelector='';for(const selector of selectors){main=document.querySelector(selector);if(main){const text=(main.textContent||main.innerText||'').trim();if(text.length>50){foundSelector=selector;debug('Found Google Sites content with selector:',selector,'Text length:',text.length);break;}else{debug('Selector found but insufficient content:',selector,'Text length:',text.length);main=null;}}}if(!main){debug('No specific Google Sites selectors worked, trying aggressive extraction');return aggressiveContentExtract();}const title=document.title||document.querySelector('h1,h2,h3,.zfr3Q')?.textContent||'Google Site';const textContent=main.textContent||main.innerText||'';debug('Google Sites extracted:',{titleLength:title.length,contentLength:textContent.length,selector:foundSelector,tag:main.tagName});return{title:title.trim(),content:main.innerHTML,textContent:textContent.trim()}};const fallbackExtract=()=>{debug('Using fallback extraction');try{return aggressiveContentExtract();}catch(e){debug('Aggressive extraction failed, using body:',e.message);const content=document.body||document.documentElement;const title=document.title||document.querySelector('h1,h2,h3')?.textContent||'Untitled';const textContent=content.textContent||content.innerText||'';debug('Final fallback:',{titleLength:title.length,contentLength:textContent.length});if(textContent.trim().length<50){throw new Error('Page appears to have no readable content (found only '+textContent.trim().length+' characters)');}return{title:title.trim(),content:content.innerHTML,textContent:textContent.trim()};}};const extractContent=()=>{try{const isGoogleSite=window.location.hostname.includes('sites.google.com')||document.querySelector('.sites-header-cell-buffer')||document.querySelector('[data-is-preview-mode]')||document.querySelector('.sites-layout')||document.querySelector('.TeI8t')||document.title.includes('Google Sites');debug('Page type detection:',{isGoogleSite,hostname:window.location.hostname,title:document.title});let article;if(isGoogleSite){article=googleSitesExtract();}else{debug('Trying Readability extraction');if(typeof window.Readability!=='undefined'){try{const documentClone=document.cloneNode(true);const reader=new window.Readability(documentClone);const readabilityResult=reader.parse();if(readabilityResult&&readabilityResult.content&&readabilityResult.textContent.trim().length>50){debug('Readability successful');article=readabilityResult;}else{debug('Readability returned insufficient content, using fallback');article=fallbackExtract();}}catch(e){debug('Readability failed:',e.message);article=fallbackExtract();}}else{debug('Readability not available, using fallback');article=fallbackExtract();}}if(!article||!article.content||!article.textContent||article.textContent.trim().length<20){debug('Insufficient content extracted:',{hasArticle:!!article,hasContent:!!(article&&article.content),hasTextContent:!!(article&&article.textContent),textLength:article&&article.textContent?article.textContent.trim().length:0});throw new Error('Could not find sufficient content on this page. Found only '+(article&&article.textContent?article.textContent.trim().length:0)+' characters. Try refreshing the page or check if the content is loaded.');}const extractedData={title:article.title||document.title||'Untitled',content:article.content,textContent:article.textContent,url:window.location.href,timestamp:Date.now(),source:'bookmarklet',pageType:isGoogleSite?'google-site':'generic',debug:{originalTextLength:article.textContent.length,isGoogleSite,hostname:window.location.hostname}};debug('Successfully extracted data:',{titleLength:extractedData.title.length,textLength:extractedData.textContent.length,pageType:extractedData.pageType});localStorage.setItem('urlToMarkdownData',JSON.stringify(extractedData));const toolUrl='https://bhwilkoff.github.io/url-to-markdown-converter/';const currentUrl=window.location.href;debug('Opening tool at:',toolUrl);if(currentUrl.includes('bhwilkoff.github.io/url-to-markdown-converter')){debug('Same site, reloading');window.location.reload();}else{debug('Opening new window');const newWindow=window.open(toolUrl,'_blank');if(!newWindow){alert('Content extracted! Please visit https://bhwilkoff.github.io/url-to-markdown-converter/ to see the results. The content has been saved and will load automatically.');}}return article;}catch(error){debug('Extraction failed:',error);const errorMsg=error?.message||error?.toString()||'Unknown error occurred';alert('Extraction failed: '+errorMsg);console.error('🔍 Bookmarklet error details:',{error,url:window.location.href,title:document.title,bodyLength:document.body?.innerHTML?.length||0,googleSiteElements:document.querySelectorAll('.jZfhZe, .VEXWte, .TeI8t').length,allDivs:document.querySelectorAll('div').length,allPs:document.querySelectorAll('p').length});return null;}};extractContent();})();" class="bookmarklet-link" id="bookmarkletLink">📄➜📝 Extract to Markdown</a>
                </div>

                <div class="instructions">
                    <h4 style="margin-bottom: 15px; color: white;">📋 How to use:</h4>
                    <ol style="color: rgba(255,255,255,0.9);">
                        <li><strong>Drag the button above</strong> to your browser's bookmarks bar</li>
                        <li><strong>Visit any webpage</strong> (public or requiring login)</li>
                        <li><strong>Click the bookmarklet</strong> in your bookmarks bar</li>
                        <li><strong>Content automatically opens</strong> in this tool for markdown conversion</li>
                    </ol>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: white;">🔧 Troubleshooting for Google Sites & Complex Pages:</h4>
                        <ul style="color: rgba(255,255,255,0.9); margin-left: 20px;">
                            <li><strong>If you get an error:</strong> Try refreshing the page first, then click the bookmarklet again</li>
                            <li><strong>For Google Sites:</strong> Make sure you're viewing the published site, not editing mode</li>
                            <li><strong>For restricted sites:</strong> Some sites block content extraction - try copying the HTML manually in the Manual HTML tab</li>
                            <li><strong>For dynamic content:</strong> Wait for the page to fully load before clicking the bookmarklet</li>
                            <li><strong>Debug info:</strong> Check the browser console (F12) for detailed extraction logs</li>
                        </ul>
                    </div>
                    
                    <p style="margin-top: 15px; opacity: 0.9;"><strong>💡 Pro tip:</strong> This works on LinkedIn, Facebook, private dashboards, internal tools, Notion pages, Google Sites, and any other authenticated content!</p>
                </div>

                <div class="button-group">
                    <button class="btn-white" onclick="copyBookmarkletCode()">
                        📋 Copy Bookmarklet Code
                    </button>
                    <button class="btn-white" onclick="testBookmarklet()">
                        🧪 Test on This Page
                    </button>
                </div>
            </div>
        </div>

        <!-- Direct URL Tab -->
        <div class="tab-content" id="direct-tab">
            <div class="input-section">
                <div class="input-group">
                    <label for="urlInput">📎 Website URL</label>
                    <input type="url" id="urlInput" placeholder="https://example.com/article" />
                    <div class="button-group">
                        <button class="btn-primary" onclick="pasteFromClipboard()">
                            📋 Paste from Clipboard & Convert
                        </button>
                        <button class="btn-secondary" onclick="convertFromURL()">
                            🔄 Convert URL
                        </button>
                    </div>
                </div>

                <div class="cors-info">
                    <h4>🔒 Limitations of Direct URL Method</h4>
                    <p><strong>✅ Works for:</strong> Public websites, most blogs, news sites, documentation</p>
                    <p><strong>❌ Won't work for:</strong> Login-required pages, some modern SPAs, CORS-protected sites</p>
                    <p><strong>💡 For authenticated content:</strong> Use the Bookmarklet tab above!</p>
                </div>
            </div>
        </div>

        <!-- Manual HTML Tab -->
        <div class="tab-content" id="manual-tab">
            <div class="input-section">
                <div class="input-group">
                    <label for="htmlInput">📄 Raw HTML Source Code</label>
                    <textarea id="htmlInput" placeholder="Paste raw HTML source code here for authenticated pages or when URL fetch fails..."></textarea>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="convertFromHTML()">
                            🔄 Convert HTML
                        </button>
                    </div>
                </div>
                <div class="cors-info">
                    <h4>📋 How to get HTML source:</h4>
                    <p>1. Visit the page in your browser while logged in</p>
                    <p>2. Right-click → "View Page Source" or press Ctrl+U (Cmd+U on Mac)</p>
                    <p>3. Copy all the HTML and paste it above</p>
                </div>
            </div>
        </div>

        <div id="statusDiv"></div>

        <div class="output-section hidden" id="outputSection">
            <div class="output-header">
                <div class="output-title">📝 Markdown Output</div>
                <div class="output-actions">
                    <button class="btn-small btn-secondary" onclick="copyToClipboard()">
                        📋 Copy
                    </button>
                    <button class="btn-small btn-success" onclick="downloadMarkdown()">
                        💾 Download
                    </button>
                    <button class="btn-small btn-primary" onclick="shareMarkdown()" id="shareBtn">
                        🔗 Share
                    </button>
                </div>
            </div>
            <textarea id="markdownOutput" readonly></textarea>
        </div>
    </div>

    <script>
        let extractedContent = '';
        let originalUrl = '';

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });

        // Initialize turndown with GFM extensions
        const turndownService = new TurndownService({
            headingStyle: 'atx',
            codeBlockStyle: 'fenced',
            fence: '```',
            emDelimiter: '*',
            strongDelimiter: '**',
            linkStyle: 'inlined',
            linkReferenceStyle: 'full',
            br: '',
            preformattedCode: false,
            blankReplacement: function (content, node) {
                return node.isBlock ? '\n\n' : '';
            },
            keepReplacement: function (content, node) {
                return node.isBlock ? '\n\n' + node.outerHTML + '\n\n' : node.outerHTML;
            },
            defaultReplacement: function (content, node) {
                return node.isBlock ? '\n\n' + content + '\n\n' : content;
            }
        });

        // Add GFM extensions
        turndownService.addRule('strikethrough', {
            filter: ['del', 's', 'strike'],
            replacement: function (content) {
                return '~~' + content + '~~';
            }
        });

        turndownService.addRule('taskList', {
            filter: function (node) {
                return node.type === 'checkbox' && node.parentNode.nodeName === 'LI';
            },
            replacement: function (content, node) {
                return (node.checked ? '[x]' : '[ ]') + ' ';
            }
        });

        turndownService.addRule('table', {
            filter: 'table',
            replacement: function (content, node) {
                const rows = Array.from(node.querySelectorAll('tr'));
                let markdown = '\n';
                
                rows.forEach((row, index) => {
                    const cells = Array.from(row.querySelectorAll('td, th'));
                    const rowContent = cells.map(cell => cell.textContent.trim()).join(' | ');
                    markdown += '| ' + rowContent + ' |\n';
                    
                    if (index === 0 && row.querySelector('th')) {
                        markdown += '|' + cells.map(() => ' --- ').join('|') + '|\n';
                    }
                });
                
                return markdown + '\n';
            }
        });

        // Check for bookmarklet data on page load
        window.addEventListener('load', function() {
            checkForBookmarkletData();
        });

        function checkForBookmarkletData() {
            const bookmarkletData = localStorage.getItem('urlToMarkdownData');
            if (bookmarkletData) {
                try {
                    const data = JSON.parse(bookmarkletData);
                    
                    // Clear the data immediately to prevent re-processing
                    localStorage.removeItem('urlToMarkdownData');
                    
                    // Show success message
                    showStatus('✅ Content extracted via bookmarklet! Processing...', 'bookmarklet');
                    
                    // Show debug info if available
                    if (data.debug) {
                        console.log('🔍 Bookmarklet data received:', data.debug);
                        showDebugInfo(data.debug);
                    }
                    
                    // Process the extracted content
                    setTimeout(() => {
                        processBookmarkletData(data);
                    }, 500);
                    
                } catch (error) {
                    console.error('Error processing bookmarklet data:', error);
                    localStorage.removeItem('urlToMarkdownData');
                    showStatus('❌ Error processing bookmarklet data: ' + error.message, 'error');
                }
            }
        }

        function showDebugInfo(debugData) {
            const statusDiv = document.getElementById('statusDiv');
            const debugHtml = `
                <div class="debug-info">
                    <strong>🔍 Debug Information:</strong><br>
                    Page Type: ${debugData.pageType || 'unknown'}<br>
                    Is Google Site: ${debugData.isGoogleSite || 'unknown'}<br>
                    Hostname: ${debugData.hostname || 'unknown'}<br>
                    Text Length: ${debugData.originalTextLength || 'unknown'} characters
                </div>
            `;
            statusDiv.innerHTML += debugHtml;
        }

        async function processBookmarkletData(data) {
            try {
                originalUrl = data.url;
                
                const pageTypeText = data.pageType === 'google-site' ? ' (Google Site)' : '';
                await showStatus(`🔄 Converting bookmarklet content to Markdown${pageTypeText}...`, 'loading');

                // Convert to Markdown
                let markdown = '';
                
                // Add title if available
                if (data.title && data.title.trim()) {
                    markdown += `# ${data.title.trim()}\n\n`;
                }

                // Add source URL if available
                if (data.url) {
                    markdown += `> Source: [${data.url}](${data.url})\n`;
                    markdown += `> Extracted: ${new Date(data.timestamp).toLocaleString()}`;
                    if (data.pageType) {
                        markdown += ` (${data.pageType})`;
                    }
                    markdown += `\n\n`;
                }

                // Convert content
                const contentMarkdown = turndownService.turndown(data.content);
                markdown += contentMarkdown;

                // Clean up the markdown
                markdown = markdown
                    .replace(/\n{3,}/g, '\n\n') // Remove excessive newlines
                    .replace(/^\s+/gm, '') // Remove leading whitespace
                    .trim();

                extractedContent = markdown;
                
                // Display the result
                document.getElementById('markdownOutput').value = markdown;
                document.getElementById('outputSection').classList.remove('hidden');
                
                const successMessage = data.pageType === 'google-site' ? 
                    `✅ Successfully converted Google Site content! Generated ${markdown.length} characters of Markdown.` :
                    `✅ Successfully converted via bookmarklet! Generated ${markdown.length} characters of Markdown from authenticated page.`;
                
                await showStatus(successMessage, 'success');
                
                // Scroll to output
                document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Bookmarklet processing error:', error);
                showStatus(`❌ Error processing bookmarklet content: ${error.message}. If this persists, try the Manual HTML tab instead.`, 'error');
            }
        }

        async function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('statusDiv');
            const existingContent = statusDiv.innerHTML;
            statusDiv.innerHTML = existingContent + `<div class="status ${type}">${message}</div>`;
            statusDiv.scrollIntoView({ behavior: 'smooth' });
        }

        async function clearStatus() {
            document.getElementById('statusDiv').innerHTML = '';
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                const urlInput = document.getElementById('urlInput');
                
                if (text && (text.startsWith('http://') || text.startsWith('https://'))) {
                    urlInput.value = text;
                    await convertFromURL();
                } else {
                    showStatus('❌ No valid URL found in clipboard. Please paste a URL manually.', 'error');
                }
            } catch (err) {
                showStatus('❌ Could not access clipboard. Please paste the URL manually.', 'error');
            }
        }

        async function convertFromURL() {
            const url = document.getElementById('urlInput').value.trim();
            
            if (!url) {
                showStatus('❌ Please enter a URL', 'error');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showStatus('❌ Please enter a valid URL starting with http:// or https://', 'error');
                return;
            }

            originalUrl = url;
            await showStatus('🔄 Fetching webpage...', 'loading');

            try {
                // Try direct fetch first
                const response = await fetch(url, {
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const html = await response.text();
                await processHTML(html, url);

            } catch (error) {
                console.error('Direct fetch failed:', error);
                
                // Try CORS proxy as fallback
                try {
                    await showStatus('🔄 Trying alternative method...', 'loading');
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Proxy failed: ${response.status}`);
                    }

                    const html = await response.text();
                    await processHTML(html, url);

                } catch (proxyError) {
                    console.error('Proxy fetch failed:', proxyError);
                    showStatus(`❌ Could not fetch URL. For authenticated content, please use the Bookmarklet tab! Error: ${error.message}`, 'error');
                }
            }
        }

        async function convertFromHTML() {
            const html = document.getElementById('htmlInput').value.trim();
            
            if (!html) {
                showStatus('❌ Please paste HTML content', 'error');
                return;
            }

            await showStatus('🔄 Processing HTML...', 'loading');
            await processHTML(html, 'Manual HTML Input');
        }

        async function processHTML(html, source) {
            try {
                // Create a DOM parser
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Check if we got valid content
                if (!doc.body || doc.body.children.length === 0) {
                    throw new Error('Could not parse HTML content');
                }

                await showStatus('🔄 Extracting main content...', 'loading');

                // Try to use Readability for content extraction
                let article;
                try {
                    const readabilityDoc = doc.cloneNode(true);
                    const reader = new Readability(readabilityDoc);
                    article = reader.parse();
                } catch (readabilityError) {
                    console.warn('Readability failed, using full body:', readabilityError);
                    article = {
                        title: doc.title || 'Untitled',
                        content: doc.body.innerHTML,
                        textContent: doc.body.textContent,
                        length: doc.body.textContent.length
                    };
                }

                if (!article || !article.content) {
                    throw new Error('Could not extract content from the page');
                }

                await showStatus('🔄 Converting to Markdown...', 'loading');

                // Convert to Markdown
                let markdown = '';
                
                // Add title if available
                if (article.title && article.title.trim()) {
                    markdown += `# ${article.title.trim()}\n\n`;
                }

                // Add source URL if available
                if (originalUrl && originalUrl !== 'Manual HTML Input') {
                    markdown += `> Source: [${originalUrl}](${originalUrl})\n\n`;
                }

                // Convert content
                const contentMarkdown = turndownService.turndown(article.content);
                markdown += contentMarkdown;

                // Clean up the markdown
                markdown = markdown
                    .replace(/\n{3,}/g, '\n\n') // Remove excessive newlines
                    .replace(/^\s+/gm, '') // Remove leading whitespace
                    .trim();

                extractedContent = markdown;
                
                // Display the result
                document.getElementById('markdownOutput').value = markdown;
                document.getElementById('outputSection').classList.remove('hidden');
                
                await showStatus(`✅ Successfully converted! Generated ${markdown.length} characters of Markdown.`, 'success');
                
                // Scroll to output
                document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                console.error('Processing error:', error);
                showStatus(`❌ Error processing content: ${error.message}`, 'error');
            }
        }

        function copyBookmarkletCode() {
            const bookmarkletLink = document.getElementById('bookmarkletLink');
            const bookmarkletCode = bookmarkletLink.href;
            
            navigator.clipboard.writeText(bookmarkletCode).then(() => {
                showStatus('✅ Bookmarklet code copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = bookmarkletCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('✅ Bookmarklet code copied to clipboard!', 'success');
            });
        }

        function testBookmarklet() {
            try {
                // Enhanced content extraction logic matching the bookmarklet
                const aggressiveContentExtract = () => {
                    console.log('🔍 Using aggressive content extraction');
                    const allElements = document.querySelectorAll('div, p, article, section, main, [role=main]');
                    let bestElement = null;
                    let maxTextLength = 0;
                    let contentElements = [];

                    for (const el of allElements) {
                        const text = (el.textContent || el.innerText || '').trim();
                        if (text.length > 100 && text.length > maxTextLength) {
                            const childDivs = el.querySelectorAll('div').length;
                            const childPs = el.querySelectorAll('p').length;
                            const totalChildren = el.children.length;
                            
                            // Look for elements with substantial content structure
                            if (childDivs + childPs > 2 || totalChildren > 3 || text.length > 500) {
                                bestElement = el;
                                maxTextLength = text.length;
                                contentElements.push({
                                    element: el,
                                    textLength: text.length,
                                    tag: el.tagName,
                                    class: el.className,
                                    id: el.id
                                });
                            }
                        }
                    }

                    console.log('🔍 Content candidates found:', contentElements.slice(0, 5));

                    if (bestElement) {
                        const title = document.title || 
                                    bestElement.querySelector('h1,h2,h3')?.textContent || 
                                    document.querySelector('h1,h2,h3')?.textContent || 
                                    'Extracted Content';
                        console.log('🔍 Selected best element:', {
                            tag: bestElement.tagName,
                            class: bestElement.className,
                            textLength: maxTextLength
                        });
                        return {
                            title: title.trim(),
                            content: bestElement.innerHTML,
                            textContent: bestElement.textContent || bestElement.innerText || ''
                        };
                    }

                    // Final fallback to body if nothing substantial found
                    const fullBodyText = (document.body.textContent || document.body.innerText || '').trim();
                    if (fullBodyText.length > 100) {
                        console.log('🔍 Using full body as fallback', { textLength: fullBodyText.length });
                        return {
                            title: document.title || 'Full Page Content',
                            content: document.body.innerHTML,
                            textContent: fullBodyText
                        };
                    }

                    throw new Error('Could not find any substantial content on this page. Page may be empty or content may be loading.');
                };

                // Check if this is a Google Site
                const isGoogleSite = window.location.hostname.includes('sites.google.com') || 
                                   document.querySelector('.sites-header-cell-buffer') || 
                                   document.querySelector('[data-is-preview-mode]') ||
                                   document.querySelector('.sites-layout') ||
                                   document.querySelector('.TeI8t') ||
                                   document.title.includes('Google Sites');

                let article;
                
                if (isGoogleSite) {
                    console.log('🔍 Detected Google Site, using Google Sites extraction');
                    // Google Sites specific extraction with comprehensive selectors
                    const selectors = [
                        '.jZfhZe', '.VEXWte', '[data-is-preview-mode] .VEXWte',
                        '[role=main]', 'main', '.sites-layout__main',
                        '.sites-canvas-main', '.sites-page-content', '.TeI8t',
                        '.XuV9uc', '.sites-embed-content-body', '.sites-page-wrapper',
                        '.sites-page-main', '.DM7qOc', '.TQc1id', '.CwaK9',
                        '.Fj6HLe div', '.oKdM2c', '.GJVK5c'
                    ];
                    
                    let main = null;
                    let foundSelector = '';
                    
                    for (const selector of selectors) {
                        main = document.querySelector(selector);
                        if (main) {
                            const text = (main.textContent || main.innerText || '').trim();
                            if (text.length > 50) {
                                foundSelector = selector;
                                console.log('🔍 Found Google Sites content with selector:', selector, 'Text length:', text.length);
                                break;
                            } else {
                                console.log('🔍 Selector found but insufficient content:', selector, 'Text length:', text.length);
                                main = null;
                            }
                        }
                    }
                    
                    if (!main) {
                        console.log('🔍 No specific Google Sites selectors worked, trying aggressive extraction');
                        article = aggressiveContentExtract();
                    } else {
                        const title = document.title || 
                                    document.querySelector('h1,h2,h3,.zfr3Q')?.textContent || 
                                    'Google Site';
                        article = {
                            title: title.trim(),
                            content: main.innerHTML,
                            textContent: main.textContent || main.innerText || ''
                        };
                    }
                } else if (typeof window.Readability !== 'undefined') {
                    // Try Readability first for non-Google sites
                    try {
                        const documentClone = document.cloneNode(true);
                        const reader = new Readability(documentClone);
                        const readabilityResult = reader.parse();
                        
                        if (readabilityResult && readabilityResult.content && readabilityResult.textContent.trim().length > 50) {
                            article = readabilityResult;
                        } else {
                            throw new Error('Readability returned insufficient content');
                        }
                    } catch (e) {
                        console.warn('🔍 Readability failed, using aggressive extraction:', e);
                        article = aggressiveContentExtract();
                    }
                } else {
                    // Use aggressive extraction when Readability is not available
                    console.log('🔍 Readability not available, using aggressive extraction');
                    article = aggressiveContentExtract();
                }

                if (article && article.content && article.textContent && article.textContent.trim().length > 20) {
                    const testData = {
                        title: 'TEST: ' + article.title,
                        content: article.content,
                        textContent: article.textContent,
                        url: window.location.href,
                        timestamp: Date.now(),
                        source: 'test',
                        pageType: isGoogleSite ? 'google-site' : 'generic',
                        debug: {
                            originalTextLength: article.textContent.length,
                            isGoogleSite,
                            hostname: window.location.hostname
                        }
                    };

                    localStorage.setItem('urlToMarkdownData', JSON.stringify(testData));
                    showStatus('✅ Test successful! Processing content...', 'success');
                    
                    setTimeout(() => {
                        checkForBookmarkletData();
                    }, 1000);
                } else {
                    showStatus('❌ Test failed: Could not extract sufficient content', 'error');
                }
            } catch (error) {
                const errorMsg = error?.message || error?.toString() || 'Unknown error occurred';
                showStatus(`❌ Test failed: ${errorMsg}`, 'error');
                console.error('🔍 Test error:', error);
            }
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(extractedContent);
                showStatus('✅ Markdown copied to clipboard!', 'success');
            } catch (err) {
                // Fallback selection method
                const textarea = document.getElementById('markdownOutput');
                textarea.select();
                document.execCommand('copy');
                showStatus('✅ Markdown copied to clipboard!', 'success');
            }
        }

        function downloadMarkdown() {
            const blob = new Blob([extractedContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Generate filename
            let filename = 'article.md';
            if (originalUrl) {
                try {
                    const urlObj = new URL(originalUrl);
                    const pathName = urlObj.pathname.split('/').pop() || 'article';
                    filename = pathName.replace(/\.[^/.]+$/, '') + '.md';
                } catch (e) {
                    // Use default filename if URL parsing fails
                }
            }
            
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('✅ Markdown file downloaded!', 'success');
        }

        async function shareMarkdown() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Converted Markdown',
                        text: extractedContent,
                    });
                    showStatus('✅ Shared successfully!', 'success');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        await copyToClipboard();
                    }
                }
            } else {
                await copyToClipboard();
            }
        }

        // Check if Web Share API is supported
        if (!navigator.share) {
            const shareBtn = document.getElementById('shareBtn');
            shareBtn.textContent = '📋 Copy';
            shareBtn.onclick = copyToClipboard;
        }

        // Auto-clear status after 5 seconds for success messages
        let statusTimeout;
        const originalShowStatus = showStatus;
        showStatus = async function(message, type = 'loading') {
            clearTimeout(statusTimeout);
            await originalShowStatus(message, type);
            
            if (type === 'success' || type === 'bookmarklet') {
                statusTimeout = setTimeout(clearStatus, 5000);
            }
        };
    </script>
</body>
</html>