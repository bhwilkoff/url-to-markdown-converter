<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL to Markdown Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/readability/0.4.4/Readability.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.2/turndown.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: #f7fafc;
            border-radius: 12px;
            padding: 4px;
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #718096;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f7fafc;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
        }

        .bookmarklet-section {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
        }

        .bookmarklet-section h3 {
            color: white;
            margin-bottom: 15px;
        }

        .bookmarklet-drag-area {
            background: rgba(255, 255, 255, 0.15);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .bookmarklet-drag-area:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .bookmarklet-link {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            color: white !important;
            text-decoration: none !important;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            cursor: grab;
        }

        .bookmarklet-link:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .bookmarklet-link:active {
            cursor: grabbing;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .instructions ol {
            margin-left: 20px;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
        }

        .bookmarklet-section label {
            color: white;
        }

        input[type="url"], textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="url"]:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f7fafc;
            color: #2d3748;
            border: 2px solid #e2e8f0;
        }

        .btn-secondary:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }

        .btn-white {
            background: white;
            color: #2d3748;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-white:hover {
            background: #f7fafc;
            transform: translateY(-2px);
        }

        .output-section {
            margin-top: 30px;
            padding: 25px;
            background: #1a202c;
            border-radius: 15px;
            position: relative;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .output-title {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .output-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        #markdownOutput {
            background: #2d3748;
            color: #e2e8f0;
            border: none;
            border-radius: 8px;
            padding: 20px;
            width: 100%;
            min-height: 400px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
        }

        .status {
            padding: 12px 16px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.loading {
            background: #bee3f8;
            color: #2a69ac;
            border: 1px solid #90cdf4;
        }

        .status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        .feature-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .feature-desc {
            color: #718096;
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .cors-info {
            background: #fef5e7;
            border: 1px solid #f6ad55;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .cors-info h4 {
            color: #c05621;
            margin-bottom: 8px;
        }

        .cors-info p {
            color: #744210;
            font-size: 14px;
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }

            .output-header {
                flex-direction: column;
                gap: 15px;
            }

            .output-actions {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔄 URL to Markdown Converter</h1>
        <p class="subtitle">Convert any webpage to clean, formatted Markdown instantly - including authenticated pages! Works on desktop and iPhone Safari.</p>

        <div class="feature-grid">
            <div class="feature-card">
                <div class="feature-title">🔐 Authenticated Access</div>
                <div class="feature-desc">Use the bookmarklet to extract content from login-protected pages while you're logged in. Works on desktop and mobile Safari!</div>
            </div>
            <div class="feature-card">
                <div class="feature-title">🧠 Smart Content Extraction</div>
                <div class="feature-desc">Uses Mozilla's Readability algorithm plus enhanced filtering to extract only the main content while removing ads, navigation, social widgets, and clutter</div>
            </div>
            <div class="feature-card">
                <div class="feature-title">📝 Clean Markdown Output</div>
                <div class="feature-desc">Generates focused, readable Markdown with intelligent link filtering, image alt-text conversion, and removal of UI elements</div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="bookmarklet">🔐 Bookmarklet (Desktop & Mobile)</div>
            <div class="tab" data-tab="direct">🌐 Direct URL</div>
            <div class="tab" data-tab="manual">📄 Manual HTML</div>
        </div>

        <!-- Bookmarklet Tab -->
        <div class="tab-content active" id="bookmarklet-tab">
            <div class="input-section bookmarklet-section">
                <h3>🔐 Extract from Authenticated Pages (Desktop & Mobile)</h3>
                <p style="margin-bottom: 20px; opacity: 0.9;">This bookmarklet works on ANY webpage - including those requiring login! Perfect for private dashboards, social media, internal tools, Google Sites, and more. Available for desktop browsers and iPhone Safari.</p>
                
                <div class="bookmarklet-drag-area">
                    <p style="margin-bottom: 15px; font-size: 18px; font-weight: 600;">📌 Drag this to your bookmarks bar:</p>
                    <a href="javascript:(function(){if(window.urlToMarkdownBookmarklet){alert('Bookmarklet already running!');return;}window.urlToMarkdownBookmarklet=true;try{const isGoogleSite=window.location.hostname.includes('sites.google.com')||document.querySelector('.sites-header-cell-buffer')||document.querySelector('[data-is-preview-mode]')||document.querySelector('.sites-layout')||document.title.includes('Google Sites');let article;if(isGoogleSite){const selectors=['.jZfhZe','.VEXWte','[data-is-preview-mode] .VEXWte','[role=main]','main','.sites-layout__main','.sites-canvas-main','.sites-page-content','.TeI8t','.XuV9uc'];let main=null;for(const sel of selectors){main=document.querySelector(sel);if(main&&(main.textContent||'').trim().length>50){break;}main=null;}if(!main){main=document.body;}article={title:document.title||'Google Site',content:main.innerHTML,textContent:main.textContent||main.innerText||''};}else{if(typeof Readability!=='undefined'){try{const documentClone=document.cloneNode(true);const reader=new Readability(documentClone,{classesToPreserve:['highlight','important'],keepClasses:false});const result=reader.parse();if(result&&result.content&&result.textContent.trim().length>100){article=result;}else{throw new Error('Readability insufficient');}}catch(e){const content=document.querySelector('article')||document.querySelector('[role=main]')||document.querySelector('main')||document.body;article={title:document.title||'Extracted Content',content:content.innerHTML,textContent:content.textContent||content.innerText||''};}}else{const content=document.querySelector('article')||document.querySelector('[role=main]')||document.querySelector('main')||document.body;article={title:document.title||'Extracted Content',content:content.innerHTML,textContent:content.textContent||content.innerText||''};}}if(!article.textContent||article.textContent.trim().length<20){throw new Error('No content found ('+article.textContent.trim().length+' chars)');}const data={title:article.title,content:article.content,textContent:article.textContent,url:window.location.href,timestamp:Date.now(),source:'bookmarklet-clipboard',pageType:isGoogleSite?'google-site':'generic'};const chars=data.textContent.length;const dataStr=JSON.stringify(data);navigator.clipboard.writeText(dataStr).then(()=>{const proceed=confirm('Content extracted ('+chars+' chars) and copied to clipboard!'+String.fromCharCode(10)+String.fromCharCode(10)+'Click OK to open converter - it will automatically process your content.');if(proceed){window.open('https://bhwilkoff.github.io/url-to-markdown-converter/?method=clipboard&chars='+chars,'_blank');}}).catch(err=>{alert('Clipboard access failed. Please use the Manual HTML tab and paste manually.'+String.fromCharCode(10)+String.fromCharCode(10)+'Extracted '+chars+' characters.');});}catch(e){alert('Error: '+e.message);}})();" class="bookmarklet-link" id="bookmarkletLink">📄➜📝 Extract to Markdown</a>
                </div>

                <div class="instructions">
                    <h4 style="margin-bottom: 15px; color: white;">📋 How to use:</h4>
                    
                    <div style="margin-bottom: 25px;">
                        <h5 style="color: white; margin-bottom: 10px;">🖥️ Desktop (Chrome, Firefox, Safari, Edge):</h5>
                        <ol style="color: rgba(255,255,255,0.9);">
                            <li><strong>Drag the button above</strong> to your browser's bookmarks bar</li>
                            <li><strong>Visit any webpage</strong> (public or requiring login)</li>
                            <li><strong>Click the bookmarklet</strong> in your bookmarks bar</li>
                            <li><strong>Content automatically processes</strong> in the converter</li>
                        </ol>
                    </div>

                    <div style="margin-bottom: 25px;">
                        <h5 style="color: white; margin-bottom: 10px;">📱 iPhone Safari:</h5>
                        <ol style="color: rgba(255,255,255,0.9);">
                            <li><strong>Tap the "Copy Bookmarklet Code" button</strong> below to copy the code</li>
                            <li><strong>Create a bookmark:</strong> Tap the Share button 📤 → "Add Bookmark"</li>
                            <li><strong>Name it:</strong> "Extract to Markdown" (or any name you prefer)</li>
                            <li><strong>Save the bookmark</strong> to your Favorites or Bookmarks</li>
                            <li><strong>Edit the bookmark:</strong> Go to Settings → Safari → Favorites</li>
                            <li><strong>Find your bookmark</strong> and tap "Edit"</li>
                            <li><strong>Replace the URL</strong> with the copied bookmarklet code (paste it)</li>
                            <li><strong>Save</strong> and you're done!</li>
                        </ol>
                        <p style="color: rgba(255,255,255,0.8); font-size: 14px; margin-top: 10px; font-style: italic;">
                            <strong>To use:</strong> Visit any webpage, tap your bookmarks button, and select "Extract to Markdown"
                        </p>
                    </div>
                    
                    <p style="margin-top: 15px; opacity: 0.9;"><strong>💡 Works on:</strong> LinkedIn, Facebook, private dashboards, internal tools, Notion pages, Google Sites, and any other authenticated content!</p>
                </div>

                <div class="button-group">
                    <button class="btn-white" onclick="copyBookmarkletCode()">
                        📋 Copy Bookmarklet Code (for Mobile)
                    </button>
                    <button class="btn-white" onclick="testBookmarklet()">
                        🧪 Test on This Page
                    </button>
                </div>
            </div>
        </div>

        <!-- Direct URL Tab -->
        <div class="tab-content" id="direct-tab">
            <div class="input-section">
                <div class="input-group">
                    <label for="urlInput">📎 Website URL</label>
                    <input type="url" id="urlInput" placeholder="https://example.com/article" />
                    <div class="button-group">
                        <button class="btn-primary" onclick="pasteFromClipboard()">
                            📋 Paste from Clipboard & Convert
                        </button>
                        <button class="btn-secondary" onclick="convertFromURL()">
                            🔄 Convert URL
                        </button>
                    </div>
                </div>

                <div class="cors-info">
                    <h4>🔒 Limitations of Direct URL Method</h4>
                    <p><strong>✅ Works for:</strong> Public websites, most blogs, news sites, documentation</p>
                    <p><strong>❌ Won't work for:</strong> Login-required pages, some modern SPAs, CORS-protected sites</p>
                    <p><strong>💡 For authenticated content:</strong> Use the Bookmarklet tab above!</p>
                </div>
            </div>
        </div>

        <!-- Manual HTML Tab -->
        <div class="tab-content" id="manual-tab">
            <div class="input-section">
                <div class="input-group">
                    <label for="htmlInput">📄 Raw HTML Source Code</label>
                    <textarea id="htmlInput" placeholder="Paste raw HTML source code here for authenticated pages or when URL fetch fails..."></textarea>
                    <div class="button-group">
                        <button class="btn-secondary" onclick="convertFromHTML()">
                            🔄 Convert HTML
                        </button>
                        <button class="btn-secondary" onclick="clearHTML()">
                            🗑️ Clear
                        </button>
                    </div>
                </div>
                <div class="cors-info">
                    <h4>📋 How to get HTML source:</h4>
                    <p>1. Visit the page in your browser while logged in</p>
                    <p>2. Right-click → "View Page Source" or press Ctrl+U (Cmd+U on Mac)</p>
                    <p>3. Copy all the HTML and paste it above</p>
                </div>
            </div>
        </div>

        <div id="statusDiv"></div>

        <div class="output-section hidden" id="outputSection">
            <div class="output-header">
                <div class="output-title">📝 Markdown Output</div>
                <div class="output-actions">
                    <button class="btn-small btn-secondary" onclick="copyToClipboard()">
                        📋 Copy
                    </button>
                    <button class="btn-small btn-success" onclick="downloadMarkdown()">
                        💾 Download
                    </button>
                    <button class="btn-small btn-primary" onclick="shareMarkdown()" id="shareBtn">
                        🔗 Share
                    </button>
                </div>
            </div>
            <textarea id="markdownOutput" readonly></textarea>
        </div>
    </div>

    <script>
        let extractedContent = '';
        let originalUrl = '';

        // Tab functionality
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName + '-tab').classList.add('active');
            });
        });

        // Enhanced content extraction and cleanup
        function cleanAndExtractContent(htmlContent, title = '', isGoogleSite = false) {
            // Create a temporary DOM for cleaning
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            if (isGoogleSite) {
                // Minimal cleaning for Google Sites - they're already fairly clean
                const minimalUnwantedSelectors = [
                    'script', 'style', 'noscript', 'iframe[src*="doubleclick"]', // Only remove ads/scripts
                    '.sites-header-cell-buffer', '.sites-footer', // Google Sites specific headers/footers
                    '[data-test-id*="ad"]', '[class*="advertisement"]' // Any obvious ads
                ];
                
                minimalUnwantedSelectors.forEach(selector => {
                    tempDiv.querySelectorAll(selector).forEach(el => el.remove());
                });
                
                // For Google Sites, preserve most images and links as they're usually content
                tempDiv.querySelectorAll('img').forEach(img => {
                    const alt = img.getAttribute('alt');
                    const src = img.getAttribute('src');
                    
                    // Only convert to alt text if it's truly descriptive
                    if (alt && alt.trim() && alt.length > 10 && !alt.toLowerCase().includes('image')) {
                        const altSpan = document.createElement('span');
                        altSpan.textContent = `[Image: ${alt.trim()}]`;
                        img.replaceWith(altSpan);
                    } else if (src && (src.includes('logo') || src.includes('icon'))) {
                        const logoSpan = document.createElement('span');
                        logoSpan.textContent = '[Logo]';
                        img.replaceWith(logoSpan);
                    }
                    // Otherwise keep the image as-is for Google Sites
                });
                
                return tempDiv.innerHTML;
            }
            
            // Full aggressive cleaning for other sites (news sites, blogs, etc.)
            const unwantedSelectors = [
                'script', 'style', 'noscript', 'iframe', 'object', 'embed',
                'nav', 'header', 'footer', 'aside',
                '.navigation', '.nav', '.menu', '.sidebar', '.widget',
                '.advertisement', '.ads', '.ad', '.banner',
                '.social', '.share', '.sharing', '.social-media',
                '.comments', '.comment', '.comment-section',
                '.related', '.related-articles', '.recommended',
                '.newsletter', '.subscribe', '.subscription',
                '.popup', '.modal', '.overlay',
                '.breadcrumb', '.breadcrumbs',
                '.tag', '.tags', '.categories',
                '.author-info', '.byline', '.bio',
                '.prev-next', '.pagination',
                '[role="complementary"]', '[role="banner"]', '[role="navigation"]',
                '.skip-link', '.screen-reader-text',
                // News site specific
                '.breaking-news', '.trending', '.most-read',
                '.weather', '.stock-ticker', '.live-blog',
                // Social media embeds
                '.twitter-tweet', '.instagram-media', '.fb-post',
                // Video/audio that won't convert well
                '.video-player', '.audio-player', '.embed-video'
            ];
            
            unwantedSelectors.forEach(selector => {
                tempDiv.querySelectorAll(selector).forEach(el => el.remove());
            });
            
            // Remove elements with common unwanted attributes
            tempDiv.querySelectorAll('[class*="ad-"], [class*="ads-"], [id*="ad-"], [id*="ads-"]').forEach(el => el.remove());
            tempDiv.querySelectorAll('[class*="social"], [class*="share"], [class*="comment"]').forEach(el => el.remove());
            
            // Clean up images - convert to alt text or remove
            tempDiv.querySelectorAll('img').forEach(img => {
                const alt = img.getAttribute('alt');
                const title = img.getAttribute('title');
                const src = img.getAttribute('src');
                
                if (alt && alt.trim() && alt.length > 5) {
                    // Replace with alt text if meaningful
                    const altSpan = document.createElement('span');
                    altSpan.textContent = `[Image: ${alt.trim()}]`;
                    img.replaceWith(altSpan);
                } else if (title && title.trim() && title.length > 5) {
                    // Use title if no alt
                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = `[Image: ${title.trim()}]`;
                    img.replaceWith(titleSpan);
                } else if (src && src.includes('logo')) {
                    // Keep logo references
                    const logoSpan = document.createElement('span');
                    logoSpan.textContent = '[Logo]';
                    img.replaceWith(logoSpan);
                } else {
                    // Remove decorative images
                    img.remove();
                }
            });
            
            // Remove empty paragraphs and divs
            tempDiv.querySelectorAll('p, div, span').forEach(el => {
                if (!el.textContent.trim()) {
                    el.remove();
                }
            });
            
            // Remove excessive links that are likely navigation
            const links = tempDiv.querySelectorAll('a');
            links.forEach(link => {
                const text = link.textContent.trim();
                const href = link.getAttribute('href');
                
                // Remove if likely navigation/UI element
                if (text.length < 4 || 
                    /^(home|back|next|prev|more|login|signup|subscribe|follow|share|like|tweet|facebook|twitter|instagram|youtube|linkedin)$/i.test(text) ||
                    text.match(/^\d+$/) || // Just numbers
                    !href || href === '#' || href.startsWith('javascript:')) {
                    // Replace with just the text content
                    link.replaceWith(document.createTextNode(text));
                }
            });
            
            return tempDiv.innerHTML;
        }

        // Initialize enhanced turndown with better content focus
        const turndownService = new TurndownService({
            headingStyle: 'atx',
            codeBlockStyle: 'fenced',
            fence: '```',
            emDelimiter: '*',
            strongDelimiter: '**',
            linkStyle: 'inlined',
            linkReferenceStyle: 'full',
            br: '',
            preformattedCode: false,
            blankReplacement: function (content, node) {
                return node.isBlock ? '\n\n' : '';
            },
            keepReplacement: function (content, node) {
                return node.isBlock ? '\n\n' + node.outerHTML + '\n\n' : node.outerHTML;
            },
            defaultReplacement: function (content, node) {
                return node.isBlock ? '\n\n' + content + '\n\n' : content;
            }
        });

        // Remove problematic elements before conversion
        turndownService.remove([
            'script', 'style', 'noscript', 'iframe', 'object', 'embed',
            'nav', 'header', 'footer', 'aside'
        ]);

        // Enhanced link handling - only keep meaningful links
        turndownService.addRule('meaningfulLinks', {
            filter: 'a',
            replacement: function(content, node) {
                const href = node.getAttribute('href');
                const text = content.trim();
                
                // Skip if no meaningful content or href
                if (!text || !href || href === '#' || href.startsWith('javascript:')) {
                    return text;
                }
                
                // For Google Sites, be more permissive with links
                const isGoogleSite = node.closest('[class*="sites-"]') || 
                                   document.querySelector('.sites-layout') ||
                                   window.location?.hostname?.includes('sites.google.com');
                
                if (isGoogleSite) {
                    // Keep most links in Google Sites as they're usually content-related
                    return `[${text}](${href})`;
                }
                
                // For other sites, be more restrictive
                if (text.length < 4 || 
                    /^(home|back|next|prev|more|login|signup|subscribe|follow|share|like|tweet|facebook|twitter|instagram|youtube|linkedin|read more|continue reading|click here)$/i.test(text)) {
                    return text;
                }
                
                // Keep meaningful links
                return `[${text}](${href})`;
            }
        });

        // Add GFM extensions
        turndownService.addRule('strikethrough', {
            filter: ['del', 's', 'strike'],
            replacement: function (content) {
                return '~~' + content + '~~';
            }
        });

        turndownService.addRule('taskList', {
            filter: function (node) {
                return node.type === 'checkbox' && node.parentNode.nodeName === 'LI';
            },
            replacement: function (content, node) {
                return (node.checked ? '[x]' : '[ ]') + ' ';
            }
        });

        turndownService.addRule('cleanTable', {
            filter: 'table',
            replacement: function (content, node) {
                const rows = Array.from(node.querySelectorAll('tr'));
                if (rows.length === 0) return '';
                
                let markdown = '\n';
                
                rows.forEach((row, index) => {
                    const cells = Array.from(row.querySelectorAll('td, th'));
                    if (cells.length === 0) return;
                    
                    const rowContent = cells.map(cell => {
                        return cell.textContent.trim().replace(/\|/g, '\\|'); // Escape pipes
                    }).join(' | ');
                    
                    if (rowContent.trim()) {
                        markdown += '| ' + rowContent + ' |\n';
                        
                        if (index === 0 && row.querySelector('th')) {
                            markdown += '|' + cells.map(() => ' --- ').join('|') + '|\n';
                        }
                    }
                });
                
                return markdown + '\n';
            }
        });

        // Clean markdown post-processing
        function cleanMarkdown(markdown) {
            return markdown
                // Fix escaped characters
                .replace(/\\"/g, '"')
                .replace(/\\'/g, "'")
                .replace(/\\\\/g, '\\')
                .replace(/\\n/g, '')
                .replace(/\\r/g, '')
                .replace(/\\t/g, ' ')
                .replace(/\\\//g, '/')
                .replace(/\\u([0-9a-fA-F]{4})/g, (match, unicode) => String.fromCharCode(parseInt(unicode, 16)))
                
                // Remove excessive whitespace and newlines
                .replace(/\n{4,}/g, '\n\n\n') // Max 3 consecutive newlines
                .replace(/[ \t]+/g, ' ') // Multiple spaces to single
                .replace(/^\s+/gm, '') // Leading whitespace
                .replace(/\s+$/gm, '') // Trailing whitespace
                
                // Clean up common issues
                .replace(/\[\s*\]/g, '') // Empty links
                .replace(/\*\*\s*\*\*/g, '') // Empty bold
                .replace(/__\s*__/g, '') // Empty bold
                .replace(/\*\s*\*/g, '') // Empty italic
                .replace(/_\s*_/g, '') // Empty italic
                .replace(/~~\s*~~/g, '') // Empty strikethrough
                
                // Fix spacing around punctuation
                .replace(/\s+([.!?])/g, '$1')
                .replace(/([.!?])\s*\n/g, '$1\n')
                
                // Remove standalone punctuation lines
                .replace(/^\s*[.,-]+\s*$/gm, '')
                
                .trim();
        }

        // Check for bookmarklet data on page load
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkForClipboardMethod();
            }, 100);
        });

        // Check for clipboard method
        function checkForClipboardMethod() {
            const urlParams = new URLSearchParams(window.location.search);
            const method = urlParams.get('method');
            
            if (method === 'clipboard') {
                const expectedChars = urlParams.get('chars');
                showStatus(`🔄 Attempting to auto-paste ${expectedChars} characters from clipboard...`, 'loading');
                
                setTimeout(async () => {
                    try {
                        const clipboardText = await navigator.clipboard.readText();
                        
                        if (clipboardText && clipboardText.length > 100) {
                            // Try to parse as JSON (bookmarklet data)
                            try {
                                const parsed = JSON.parse(clipboardText);
                                if (parsed.content && parsed.textContent && parsed.source && parsed.source.includes('bookmarklet')) {
                                    showStatus('✅ Content auto-processed from clipboard!', 'success');
                                    setTimeout(() => {
                                        processBookmarkletData(parsed);
                                    }, 500);
                                    return;
                                }
                            } catch (e) {
                                // Not JSON, treat as raw HTML and paste it
                                document.getElementById('htmlInput').value = clipboardText;
                                document.querySelector('[data-tab="manual"]').click();
                                showStatus('✅ Content auto-pasted! Click "Convert HTML" to process.', 'success');
                                return;
                            }
                        }
                        
                        // If we get here, clipboard was empty or too small
                        throw new Error('Clipboard was empty or too small');
                        
                    } catch (error) {
                        // Auto-read failed, switch to manual tab and provide instructions
                        document.querySelector('[data-tab="manual"]').click();
                        document.getElementById('htmlInput').focus();
                        
                        showStatus('📋 Content copied to clipboard! Press Ctrl+V (or Cmd+V) to paste it below, then click "Convert HTML".', 'loading');
                        
                        // Add a helper to detect when user pastes
                        const htmlInput = document.getElementById('htmlInput');
                        htmlInput.addEventListener('paste', function handlePaste() {
                            setTimeout(() => {
                                if (htmlInput.value.length > 100) {
                                    showStatus('✅ Content pasted! Click "Convert HTML" to process.', 'success');
                                    htmlInput.removeEventListener('paste', handlePaste);
                                }
                            }, 100);
                        }, { once: true });
                    }
                }, 1000);
                
                return true;
            }
            
            return false;
        }

        async function processBookmarkletData(data) {
            try {
                originalUrl = data.url;
                
                const pageTypeText = data.pageType === 'google-site' ? ' (Google Site)' : '';
                showStatus(`🔄 Converting content to Markdown${pageTypeText}...`, 'loading');

                // Enhanced content cleaning and extraction
                const isGoogleSite = data.pageType === 'google-site';
                const cleanContent = cleanAndExtractContent(data.content, data.title, isGoogleSite);

                // Convert to Markdown
                let markdown = '';
                
                // Add title if available
                if (data.title && data.title.trim()) {
                    markdown += `# ${data.title.trim()}\n\n`;
                }

                // Add source URL if available
                if (data.url) {
                    markdown += `> Source: [${data.url}](${data.url})\n`;
                    markdown += `> Extracted: ${new Date(data.timestamp).toLocaleString()}`;
                    if (data.pageType) {
                        markdown += ` (${data.pageType})`;
                    }
                    markdown += `\n\n`;
                }

                // Convert content using enhanced turndown
                const contentMarkdown = turndownService.turndown(cleanContent);
                markdown += contentMarkdown;

                // Apply final markdown cleanup
                markdown = cleanMarkdown(markdown);

                extractedContent = markdown;
                
                // Display the result
                document.getElementById('markdownOutput').value = markdown;
                document.getElementById('outputSection').classList.remove('hidden');
                
                const successMessage = data.pageType === 'google-site' ? 
                    `✅ Successfully converted Google Site content! Generated ${markdown.length} characters of clean Markdown.` :
                    `✅ Successfully converted! Generated ${markdown.length} characters of clean Markdown.`;
                
                showStatus(successMessage, 'success');
                
                // Scroll to output
                document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                showStatus(`❌ Error processing content: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('statusDiv');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function clearStatus() {
            document.getElementById('statusDiv').innerHTML = '';
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                const urlInput = document.getElementById('urlInput');
                
                if (text && (text.startsWith('http://') || text.startsWith('https://'))) {
                    urlInput.value = text;
                    await convertFromURL();
                } else {
                    showStatus('❌ No valid URL found in clipboard. Please paste a URL manually.', 'error');
                }
            } catch (err) {
                showStatus('❌ Could not access clipboard. Please paste the URL manually.', 'error');
            }
        }

        async function convertFromURL() {
            const url = document.getElementById('urlInput').value.trim();
            
            if (!url) {
                showStatus('❌ Please enter a URL', 'error');
                return;
            }

            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                showStatus('❌ Please enter a valid URL starting with http:// or https://', 'error');
                return;
            }

            originalUrl = url;
            showStatus('🔄 Fetching webpage...', 'loading');

            try {
                // Try direct fetch first
                const response = await fetch(url, {
                    mode: 'cors',
                    credentials: 'omit'
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const html = await response.text();
                await processHTML(html, url);

            } catch (error) {
                // Try CORS proxy as fallback
                try {
                    showStatus('🔄 Trying alternative method...', 'loading');
                    const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Proxy failed: ${response.status}`);
                    }

                    const html = await response.text();
                    await processHTML(html, url);

                } catch (proxyError) {
                    showStatus(`❌ Could not fetch URL. For authenticated content, please use the Bookmarklet tab!`, 'error');
                }
            }
        }

        async function convertFromHTML() {
            const html = document.getElementById('htmlInput').value.trim();
            
            if (!html) {
                showStatus('❌ Please paste HTML content', 'error');
                return;
            }

            showStatus('🔄 Processing HTML...', 'loading');
            await processHTML(html, 'Manual HTML Input');
        }

        function clearHTML() {
            document.getElementById('htmlInput').value = '';
            clearStatus();
        }

        async function processHTML(html, source) {
            try {
                // Create a DOM parser
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // Check if we got valid content
                if (!doc.body || doc.body.children.length === 0) {
                    throw new Error('Could not parse HTML content');
                }

                showStatus('🔄 Extracting main content with enhanced algorithms...', 'loading');

                // Enhanced content extraction using Readability when possible
                let article;
                try {
                    const readabilityDoc = doc.cloneNode(true);
                    const reader = new Readability(readabilityDoc, {
                        classesToPreserve: ['highlight', 'important'],
                        keepClasses: false,
                        charThreshold: 500 // Require substantial content
                    });
                    article = reader.parse();
                    
                    if (!article || !article.content || article.textContent.trim().length < 100) {
                        throw new Error('Readability extraction insufficient');
                    }
                    
                    console.log('✅ Used Readability for content extraction');
                } catch (readabilityError) {
                    console.log('Readability failed, using fallback extraction');
                    
                    // Fallback to manual content selection
                    const contentSelectors = [
                        'article',
                        '[role="main"]',
                        'main',
                        '.content',
                        '.post-content',
                        '.entry-content',
                        '.article-content',
                        '.story-body',
                        '.post-body'
                    ];
                    
                    let contentElement = null;
                    for (const selector of contentSelectors) {
                        contentElement = doc.querySelector(selector);
                        if (contentElement && contentElement.textContent.trim().length > 100) {
                            break;
                        }
                    }
                    
                    if (!contentElement) {
                        contentElement = doc.body;
                    }
                    
                    article = {
                        title: doc.title || 'Untitled',
                        content: contentElement.innerHTML,
                        textContent: contentElement.textContent,
                        length: contentElement.textContent.length
                    };
                }

                if (!article || !article.content) {
                    throw new Error('Could not extract content from the page');
                }

                showStatus('🔄 Converting to clean Markdown...', 'loading');

                // Detect if this is a Google Site
                const isGoogleSite = originalUrl.includes('sites.google.com') || 
                                   article.content.includes('sites-layout') ||
                                   article.content.includes('sites-header-cell-buffer') ||
                                   article.title.includes('Google Sites');

                // Enhanced content cleaning and extraction
                const cleanContent = cleanAndExtractContent(article.content, article.title, isGoogleSite);

                // Convert to Markdown
                let markdown = '';
                
                // Add title if available
                if (article.title && article.title.trim()) {
                    markdown += `# ${article.title.trim()}\n\n`;
                }

                // Add source URL if available
                if (originalUrl && originalUrl !== 'Manual HTML Input') {
                    markdown += `> Source: [${originalUrl}](${originalUrl})\n\n`;
                }

                // Convert content using enhanced turndown
                const contentMarkdown = turndownService.turndown(cleanContent);
                markdown += contentMarkdown;

                // Apply final markdown cleanup
                markdown = cleanMarkdown(markdown);

                extractedContent = markdown;
                
                // Display the result
                document.getElementById('markdownOutput').value = markdown;
                document.getElementById('outputSection').classList.remove('hidden');
                
                showStatus(`✅ Successfully converted! Generated ${markdown.length} characters of clean, focused Markdown.${isGoogleSite ? ' (Google Sites content preserved)' : ''}`, 'success');
                
                // Scroll to output
                document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });

            } catch (error) {
                showStatus(`❌ Error processing content: ${error.message}`, 'error');
            }
        }

        async function copyToClipboard() {
            try {
                await navigator.clipboard.writeText(extractedContent);
                showStatus('✅ Markdown copied to clipboard!', 'success');
            } catch (err) {
                // Fallback selection method
                const textarea = document.getElementById('markdownOutput');
                textarea.select();
                document.execCommand('copy');
                showStatus('✅ Markdown copied to clipboard!', 'success');
            }
        }

        function downloadMarkdown() {
            const blob = new Blob([extractedContent], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            // Generate filename
            let filename = 'article.md';
            if (originalUrl) {
                try {
                    const urlObj = new URL(originalUrl);
                    const pathName = urlObj.pathname.split('/').pop() || 'article';
                    filename = pathName.replace(/\.[^/.]+$/, '') + '.md';
                } catch (e) {
                    // Use default filename if URL parsing fails
                }
            }
            
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            
            showStatus('✅ Markdown file downloaded!', 'success');
        }

        async function shareMarkdown() {
            if (navigator.share) {
                try {
                    await navigator.share({
                        title: 'Converted Markdown',
                        text: extractedContent,
                    });
                    showStatus('✅ Shared successfully!', 'success');
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        await copyToClipboard();
                    }
                }
            } else {
                await copyToClipboard();
            }
        }

        // Check if Web Share API is supported
        if (!navigator.share) {
            const shareBtn = document.getElementById('shareBtn');
            shareBtn.textContent = '📋 Copy';
            shareBtn.onclick = copyToClipboard;
        }

        // Auto-clear status after 5 seconds for success messages
        let statusTimeout;
        const originalShowStatus = showStatus;
        showStatus = function(message, type = 'loading') {
            clearTimeout(statusTimeout);
            originalShowStatus(message, type);
            
            if (type === 'success') {
                statusTimeout = setTimeout(clearStatus, 5000);
            }
        };

        function copyBookmarkletCode() {
            const bookmarkletLink = document.getElementById('bookmarkletLink');
            const bookmarkletCode = bookmarkletLink.href;
            
            navigator.clipboard.writeText(bookmarkletCode).then(() => {
                showStatus('✅ Bookmarklet code copied to clipboard! Now create a bookmark in Safari and replace its URL with this code.', 'success');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = bookmarkletCode;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showStatus('✅ Bookmarklet code copied to clipboard! Now create a bookmark in Safari and replace its URL with this code.', 'success');
            });
        }

        function testBookmarklet() {
            try {
                // Simple extraction for testing
                const isGoogleSite = window.location.hostname.includes('sites.google.com') ||
                                   document.querySelector('.sites-layout') ||
                                   document.querySelector('.sites-header-cell-buffer');
                let content, textContent, title;
                
                if (isGoogleSite) {
                    // Google Sites extraction logic
                    const selectors = ['.jZfhZe', '.VEXWte', '[role=main]', 'main', '.sites-layout__main', '.sites-canvas-main'];
                    let main = null;
                    for (const sel of selectors) {
                        main = document.querySelector(sel);
                        if (main && (main.textContent || '').trim().length > 50) break;
                        main = null;
                    }
                    if (!main) main = document.body;
                    content = main.innerHTML;
                    textContent = main.textContent || main.innerText || '';
                    title = document.title || 'Google Site';
                } else {
                    // Regular page extraction
                    const contentEl = document.querySelector('article') || 
                                    document.querySelector('[role=main]') || 
                                    document.querySelector('main') || 
                                    document.body;
                    content = contentEl.innerHTML;
                    textContent = contentEl.textContent || contentEl.innerText || '';
                    title = document.title || 'Test Page';
                }

                if (!textContent || textContent.trim().length < 20) {
                    throw new Error('Not enough content found for testing');
                }

                const data = {
                    title: title,
                    content: content,
                    textContent: textContent,
                    url: window.location.href,
                    timestamp: Date.now(),
                    source: 'bookmarklet-test',
                    pageType: isGoogleSite ? 'google-site' : 'generic'
                };

                const chars = data.textContent.length;
                const siteType = isGoogleSite ? ' (Google Site)' : '';
                showStatus(`✅ Test successful! Extracted ${chars} characters${siteType}. Processing...`, 'success');
                
                setTimeout(() => {
                    processBookmarkletData(data);
                }, 1000);

            } catch (error) {
                showStatus(`❌ Test failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>